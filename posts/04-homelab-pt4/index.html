<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>üè° Homelab IV: Proxmox Dynamic Inventory and LXC Templates | rob's blog</title><link rel=icon type=image/png href=https://blog.reb.gg/images/logo.png><meta property="og:url" content="https://blog.reb.gg/posts/04-homelab-pt4/">
<meta property="og:site_name" content="rob's blog"><meta property="og:title" content="üè° Homelab IV: Proxmox Dynamic Inventory and LXC Templates"><meta property="og:description" content="In the previous part of this series, I configured Ansible and made some basic playbooks for the homelab management. Eventually, I‚Äôll be deploying a plethora of VMs and containers, but managing a gigantic inventory every time a guest is spun up/down would be a hassle. Fortunately, there are community plugins for Ansible that allow the use of a Proxmox cluster as a dynamic inventory.
In this part, I‚Äôll setup some Proxmox API users for automation, setup a dynamic inventory for Proxmox guests and prepare a template for Linux containers."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-12T00:00:00-05:00"><meta property="article:modified_time" content="2022-01-12T00:00:00-05:00"><meta property="article:tag" content="Proxmox"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Lxc"><meta property="article:tag" content="Systemd"><meta name=twitter:card content="summary"><meta name=twitter:title content="üè° Homelab IV: Proxmox Dynamic Inventory and LXC Templates"><meta name=twitter:description content="In the previous part of this series, I configured Ansible and made some basic playbooks for the homelab management. Eventually, I‚Äôll be deploying a plethora of VMs and containers, but managing a gigantic inventory every time a guest is spun up/down would be a hassle. Fortunately, there are community plugins for Ansible that allow the use of a Proxmox cluster as a dynamic inventory.
In this part, I‚Äôll setup some Proxmox API users for automation, setup a dynamic inventory for Proxmox guests and prepare a template for Linux containers."><link rel=stylesheet href=/css/custom.min.faefcaabf97ea44e2b9626162349aeb966c6ea5166b9d744503b93cdd81173ad.css integrity="sha256-+u/Kq/l+pE4rliYWI0muuWbG6lFmuddEUDuTzdgRc60=" crossorigin=anonymous><link rel=stylesheet href=/css/article.min.3d68b337d54382250563c3c74528261d25b316f1df232ec198665d91e6621ba7.css integrity="sha256-PWizN9VDgiUFY8PHRSgmHSWzFvHfIy7BmGZdkeZiG6c=" crossorigin=anonymous><link rel=stylesheet href=/css/fonts.min.e0bf373169e09cf6dfc780f970638fcd39a5898dcecb6c9286f170d5907dbbf5.css integrity="sha256-4L83MWngnPbfx4D5cGOPzTmliY3Oy2yShvFw1ZB9u/U=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.61771936e5acd378a831a0ce3858ec58f08eeb0598159d8d3477988eb62c02ee.css integrity="sha256-YXcZNuWs03ioMaDOOFjsWPCO6wWYFZ2NNHeYjrYsAu4=" crossorigin=anonymous><link rel=stylesheet href=/css/simple-icons.min.min.8e53216f6540542c220ed40839d164fb18b299e5d70551cb60b0600d3f0a011f.css integrity="sha256-jlMhb2VAVCwiDtQIOdFk+xiymeXXBVHLYLBgDT8KAR8=" crossorigin=anonymous><style>:root{--color-primary:var(--color-blue-6)}</style><script src=/js/main.95176a6398aade31e73736833a061caca263c49d5f1e01d192b9e651423e0f8c.js integrity="sha256-lRdqY5iq3jHnNzaDOgYcrKJjxJ1fHgHRkrnmUUI+D4w=" crossorigin=anonymous></script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script></head><body><header><h1 class=site-title><span role=img aria-label=emoji-logo>üíæ
</span><a href=https://blog.reb.gg/>rob's blog</a></h1><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></nav></header><main><article><h1 class=title>üè° Homelab IV: Proxmox Dynamic Inventory and LXC Templates</h1><div class=meta><time datetime=2022-01-12T00:00:00-05:00>January 12, 2022</time> &#183; 7 min read</div><div class=tags><a class=tag href=/tags/proxmox/>Proxmox</a>
<a class=tag href=/tags/ansible/>Ansible</a>
<a class=tag href=/tags/lxc/>Lxc</a>
<a class=tag href=/tags/systemd/>Systemd</a></div><div class=markdown-body><p>In the previous part of this series, I configured Ansible and made some basic playbooks for the homelab management. Eventually, I&rsquo;ll be deploying a plethora of VMs and containers, but managing a gigantic inventory every time a guest is spun up/down would be a hassle. Fortunately, there are community plugins for Ansible that allow the use of a Proxmox cluster as a <a href=https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html>dynamic inventory</a>.</p><p>In this part, I&rsquo;ll setup some Proxmox API users for automation, setup a dynamic inventory for Proxmox guests and prepare a template for Linux containers.</p><h2 id=creating-an-automation-group-and-user><a href=#creating-an-automation-group-and-user>#</a>
Creating an automation group and user</h2><p>Permissions on Proxmox are scoped to a cluster, which is great since only need a single user is required to interact with both Proxmox nodes APIs. For a single node Proxmox installation, this&rsquo;ll be the exact same process. A user called <code>ansible</code> will be made in the built in <a href=https://pve.proxmox.com/wiki/User_Management#pveum_authentication_realms>PVE realm</a> using the <code>pveum</code> utility. Note: for <code>pveum</code> (like most Proxmox CLI tools) must be accessed by the <code>root</code> user, so escalation (<code>sudo su -</code>) from a non-root user is required. Alternatively, these steps can also be done via the web console under Datacenter > Permissions.</p><p>On one of the Proxmox nodes:</p><ol><li>Create a group called <code>automation</code>:<div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveum group add automation</span></span></code></pre></div></li><li>Since this will group will be primarily for managing the entire system, it&rsquo;ll be assigned to the Administrator role:<div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveum acl modify / --group automation --role Administrator</span></span></code></pre></div></li><li>And then make the <code>ansible</code> user, add it to the automation group, and set a password:<div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveum user add ansible@pve --groups automation --password &lt;some password&gt;</span></span></code></pre></div></li></ol><h2 id=proxmox-plugin-for-ansible><a href=#proxmox-plugin-for-ansible>#</a>
Proxmox plugin for Ansible</h2><p>Ansible has a great community that develop <a href=https://docs.ansible.com/ansible/latest/plugins/plugins.html>plugins</a> to extend Ansible&rsquo;s core functionality. Within the <code>community.general</code> collection, there&rsquo;s a ton of useful plugins for inventories, configurations, packages, etc. This module is usually included within the default <code>ansible</code> package, but for the sake of verbosity, a requirements file can be made:</p><p>In <code>ansible/requirements.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ca9ee6>collections</span>:
</span></span><span style=display:flex><span>  - community.general
</span></span></code></pre></div><p>Any additional collections can be added to the requirements file. And to install them, they must be pulled from <a href=https://docs.ansible.com/ansible/latest/galaxy/user_guide.html>ansible-galaxy</a>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible-galaxy install -r requirements.yml</span></span></code></pre></div><p>The specific plugin <code>community.general.proxmox</code> is used to configure a <a href=https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_inventory.html>dynamic inventory</a>. There is also a <a href=https://docs.ansible.com/ansible/latest/collections/community/general/proxmox_module.html>module</a> within that same plugin that can be used to manage instances within tasks.</p><h2 id=proxmox-as-a-dynamic-inventory><a href=#proxmox-as-a-dynamic-inventory>#</a>
Proxmox as a dynamic inventory</h2><p>A new inventory file will hold the configuration for the dynamic inventory:</p><p>In <code>ansible/inventory/proxmox.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ca9ee6>plugin</span>: community.general.proxmox
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>url</span>: https://192.168.1.100:8006
</span></span><span style=display:flex><span><span style=color:#ca9ee6>user</span>: ansible@pve
</span></span><span style=display:flex><span><span style=color:#ca9ee6>password</span>: !vault |
</span></span><span style=display:flex><span>  $ANSIBLE_VAULT;1.1;AES256
</span></span><span style=display:flex><span>  <span style=color:#ef9f76>32376266393636643961653739613661626433363062393334663432303533393337353866333633</span>
</span></span><span style=display:flex><span>  3630363966333562346162626466336538366532333864300a633333353237326662386466653431
</span></span><span style=display:flex><span>  <span style=color:#ef9f76>63333061353533666233313334356238323137313861363630313161613336303739663733306135</span>
</span></span><span style=display:flex><span>  6637663436306537650a633566343734313230343632336130623435383931333732376538383665
</span></span><span style=display:flex><span>  <span style=color:#ef9f76>64393730313335343035333966636133306639633439393434363130366466303635</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>validate_certs</span>: <span style=color:#ef9f76>false</span> <span style=color:#737994;font-style:italic># enable if/when proxmox has valid certificates</span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>want_facts</span>: <span style=color:#ef9f76>true</span> <span style=color:#737994;font-style:italic># collect vm/container metadata as facts</span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>want_proxmox_nodes_ansible_host</span>: <span style=color:#ef9f76>false</span> <span style=color:#737994;font-style:italic># override `ansible_host` for node</span>
</span></span></code></pre></div><p>The <code>user</code> and <code>password</code> are from the <code>ansible</code> user just previously configured. To get the giant encrypted block of a password, it&rsquo;s the following command:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible-vault encrypt_string &lt;ansible user password&gt;</span></span></code></pre></div><p>Note: Unlike the user password in the previous part of this series, this password does not need to be hashed or salted. The value is being passed as API authentication to Proxmox.</p><p>One of the great things about dynamic inventories is that they add additional groups based on specific Proxmox <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html><em>facts</em></a>. For instance, the group <code>proxmox_all_running</code> returns any VMs or containers running, which we can add to a playbook:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#ca9ee6>name</span>: some-playbook
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>hosts</span>:
</span></span><span style=display:flex><span>    - proxmox_all_running
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>tasks</span>:
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><p>To see a list of all facts in an inventory, the following command can be used:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible-inventory --list</span></span></code></pre></div><p>A new LXC can be used for a quick test of the inventory. On one of the nodes, download the Ubuntu container image using <a href=https://pve.proxmox.com/pve-docs/pveam.1.html><code>pveam</code></a> (or web console: Node > Storage > CT Templates > Templates):</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveam update
</span></span><span style=display:flex><span>update successful
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveam available --section system | grep ubuntu
</span></span><span style=display:flex><span>system          ubuntu-16.04-standard_16.04.5-1_amd64.tar.gz
</span></span><span style=display:flex><span>system          ubuntu-18.04-standard_18.04.1-1_amd64.tar.gz
</span></span><span style=display:flex><span>system          ubuntu-20.04-standard_20.04-1_amd64.tar.gz
</span></span><span style=display:flex><span>system          ubuntu-21.04-standard_21.04-1_amd64.tar.gz
</span></span><span style=display:flex><span>system          ubuntu-21.10-standard_21.10-1_amd64.tar.zst
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveam download rusty-dir ubuntu-20.04-standard_20.04-1_amd64.tar.gz
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveam list rusty-dir
</span></span><span style=display:flex><span>NAME                                                         SIZE
</span></span><span style=display:flex><span>rusty-dir:vztmpl/ubuntu-20.04-standard_20.04-1_amd64.tar.gz      204.28MB</span></span></code></pre></div><p>Now that the image is downloaded, time to create a container using <a href=https://pve.proxmox.com/pve-docs/pct.1.html><code>pct</code></a> (or web console: Top Left > Create CT):</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span><span style=color:#f2d5cf>IMG_PATH</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>&#39;rusty-dir:vztmpl/ubuntu-20.04-standard_20.04-1_amd64.tar.gz&#39;</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct create <span style=color:#ef9f76>101</span> <span style=color:#f2d5cf>$IMG_PATH</span> --hostname tmp-ct --rootfs ssd-mirror:8 --net0 <span style=color:#f2d5cf>name</span><span style=color:#99d1db;font-weight:700>=</span>eth0,bridge<span style=color:#99d1db;font-weight:700>=</span>vmbr0,ip<span style=color:#99d1db;font-weight:700>=</span>dhcp --password tmp-password --start</span></span></code></pre></div><p>To summarize the above, a container was created with id of <code>101</code> and a hostname of <code>tmp-ct</code>. The additional configuration options are for the filesystem storage and setting up a network interface. A password will need to be set to interact with the container.</p><p>To test the Ansible setup, an interactive console is required to add a default user called <code>rob</code> with the expected SSH keys:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct console <span style=color:#ef9f76>101</span> <span style=color:#737994;font-style:italic># login is `root` with the password from `pct create`</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@tmp-ct$ </span>apt update
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@tmp-ct$ </span>apt install ssh-import-id
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@tmp-ct$ </span>adduser rob
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@tmp-ct$ </span>su rob
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@tmp-ct$ </span>ssh-import-id-gh robherley</span></span></code></pre></div><p>Now, when all the Ansible hosts are pinged, the new container appears:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible all -m ping
</span></span><span style=display:flex><span>nuc | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>r720 | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>tmp-ct | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>piprimary | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span></span></span></code></pre></div><p>It can also be found under the <code>proxmox_all_running</code> group mentioned before:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible proxmox_all_running -m ping
</span></span><span style=display:flex><span>tmp-ct | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span></span></span></code></pre></div><p>Finally, the temporary container can be cleaned up:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct stop <span style=color:#ef9f76>101</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct destroy <span style=color:#ef9f76>101</span></span></span></code></pre></div><h2 id=lxc-templates><a href=#lxc-templates>#</a>
LXC Templates</h2><p>Now would be a good time to create a template for any other Ubuntu containers that may be needed in the future.</p><p>Make a new container with specific sizing for memory and cpu:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span><span style=color:#f2d5cf>IMG_PATH</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>&#39;rusty-dir:vztmpl/ubuntu-20.04-standard_20.04-1_amd64.tar.gz&#39;</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct create <span style=color:#ef9f76>1000</span> <span style=color:#f2d5cf>$IMG_PATH</span> <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--hostname ubuntu-ct-template <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--rootfs ssd-mirror:16 <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--net0 <span style=color:#f2d5cf>name</span><span style=color:#99d1db;font-weight:700>=</span>eth0,bridge<span style=color:#99d1db;font-weight:700>=</span>vmbr0,firewall<span style=color:#99d1db;font-weight:700>=</span>1,ip<span style=color:#99d1db;font-weight:700>=</span>dhcp <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--memory <span style=color:#ef9f76>4096</span> <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--cores <span style=color:#ef9f76>2</span> <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--password &lt;root password&gt; <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--start</span></span></code></pre></div><p>Similar to before, go into the container and give it the bare minimal setup for an Ansible connection. But this time, the container will need to be cleaned up so it can be templated.</p><p>Add the <code>ssh-import-id</code> package, make the <code>rob</code> user, import keys, and allow passwordless sudo:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct console <span style=color:#ef9f76>1000</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>apt update <span style=color:#99d1db;font-weight:700>&amp;&amp;</span> apt dist-upgrade
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>apt install ssh-import-id
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>apt autoremove <span style=color:#99d1db;font-weight:700>&amp;&amp;</span> apt clean
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>adduser rob --shell /bin/bash
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>usermod -aG sudo rob
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>su rob
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@ubuntu-ct-template$ </span>ssh-import-id-gh robherley
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@ubuntu-ct-template$ </span><span style=color:#99d1db>exit</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>visudo /etc/sudoers <span style=color:#737994;font-style:italic># allow passwordless sudo</span></span></span></code></pre></div><p>Now, here&rsquo;s a minor annoyance. When the container template is copied, it also copies all of the host keys as well, so any cloned container will have the same fingerprint. Those host keys need to be deleted:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>rm /etc/ssh/ssh_host_*</span></span></code></pre></div><p>But, host keys will be required in order to SSH to the container. To rememdy this, I&rsquo;ll make a systemd service to autogenerate host keys at startup:</p><p>In <code>/etc/systemd/system/autohostkeys.service</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>Description=Auto Create Host Keys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>ExecStart=/usr/bin/ssh-keygen -A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=default.target
</span></span></code></pre></div><p>Then enable the service (but don&rsquo;t start it):</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@ubuntu-ct-template$ </span>systemctl <span style=color:#99d1db>enable</span> autohostkeys</span></span></code></pre></div><p>Finally the container can be shutdown, and converted to a template:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct shutdown <span style=color:#ef9f76>1000</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct <span style=color:#99d1db>set</span> <span style=color:#ef9f76>1000</span> --template <span style=color:#ef9f76>1</span></span></span></code></pre></div><p>Now, time to clone a couple containers and see if they are reachable from Ansible:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct clone <span style=color:#ef9f76>1000</span> <span style=color:#ef9f76>101</span> --full --hostname dolly1
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct clone <span style=color:#ef9f76>1000</span> <span style=color:#ef9f76>102</span> --full --hostname dolly2
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct start <span style=color:#ef9f76>101</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pct start <span style=color:#ef9f76>102</span></span></span></code></pre></div><p>And ping the Proxmox running group:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>ansible proxmox_all_running -m ping
</span></span><span style=display:flex><span>dolly2 | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>dolly1 | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span></span></span></code></pre></div><p>And a quick double check to make sure the host keys generated properly:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@dolly1$ </span>cat /etc/ssh/ssh_host_ecdsa_key.pub
</span></span><span style=display:flex><span>ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAWQVuOd8PNu88qXJ+HYevHc0mwiJ1+G1UUravyXm6tDZrxtmDvbzcOqaE2jEb10qLKRV7ILx1RKrxyHWQo2qRk<span style=color:#99d1db;font-weight:700>=</span> root@dolly1
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@dolly2$ </span>cat /etc/ssh/ssh_host_ecdsa_key.pub
</span></span><span style=display:flex><span>ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOEj3rEWJhb5fWv+IXtKTy3R6xtpOtMeBfAOo6Qq5/wLxoJmoh5kTekoJJ5tuTahycLhedakbY0Zxexjog8a3dY<span style=color:#99d1db;font-weight:700>=</span> root@dolly2</span></span></code></pre></div><p>Perfect, now containers can be cloned and immediately wired up to Ansible after provision. And to harden them, the new <code>proxmox_all_running</code> host group can be added to the existing playbooks.</p><h2 id=next><a href=#next>#</a>
Next</h2><p>With dynamic inventory, any Linux VM/container running in the Proxmox cluster can be seen by Ansible automatically. And with the prepared LXC templates, clones are ready to go for automation with any manual intervention. In the next part, I&rsquo;ll go over how to use cloud-init so the same level of automation can be achieved for virtual machine clones.</p></div></article><div class=prev-next><div><a href=https://blog.reb.gg/posts/03-homelab-pt3/>&#8592; Prev</a>
<span>üè° Homelab III: Automation with Ansible ‚Ä¶</span></div><div><a style=align-self:flex-end href=https://blog.reb.gg/posts/05-homelab-pt5/>Next &#8594;</a>
<span>üè° Homelab V: Proxmox VMs and cloud-init</span></div></div></main><footer><div class=stripes></div><div class=footer-meta><div><div>2024 Rob Herley</div><div>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> &
      <a href=https://github.com/robherley/rebugo target=_blank rel="noopener noreferrer">robherley/rebugo</a></div></div><div class=socials><a href=https://github.com/robherley rel=author title=github><i class="si si-github"></i></a><a href=https://x.com/robherley rel=author title=x><i class="si si-x"></i></a><a href=https://instagram.com/robherley rel=author title=instagram><i class="si si-instagram"></i></a><a href=https://www.linkedin.com/in/robherley/ rel=author title=linkedin><i class="si si-linkedin"></i></a></div></div></footer></body></html>