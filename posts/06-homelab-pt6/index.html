<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>üè° Homelab VI: Terraforming Proxmox | rob's blog</title><link rel=icon type=image/png href=https://blog.reb.gg/images/logo.png>
<link rel=stylesheet href=/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=" crossorigin=anonymous><link rel=stylesheet href=/css/article.min.3d68b337d54382250563c3c74528261d25b316f1df232ec198665d91e6621ba7.css integrity="sha256-PWizN9VDgiUFY8PHRSgmHSWzFvHfIy7BmGZdkeZiG6c=" crossorigin=anonymous><link rel=stylesheet href=/css/fonts.min.e0bf373169e09cf6dfc780f970638fcd39a5898dcecb6c9286f170d5907dbbf5.css integrity="sha256-4L83MWngnPbfx4D5cGOPzTmliY3Oy2yShvFw1ZB9u/U=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.a99e7b40557c65a8aaa63ef4a655897fcf2f50744c881928d760edc27bb27fed.css integrity="sha256-qZ57QFV8Zaiqpj70plWJf88vUHRMiBko12Dtwnuyf+0=" crossorigin=anonymous><link rel=stylesheet href=/css/simple-icons.min.min.8e53216f6540542c220ed40839d164fb18b299e5d70551cb60b0600d3f0a011f.css integrity="sha256-jlMhb2VAVCwiDtQIOdFk+xiymeXXBVHLYLBgDT8KAR8=" crossorigin=anonymous><style>:root{--color-primary:var(--color-blue-6)}</style><script src=/js/main.ec400c542ae0486a91bf8b446dfa1a0efef0138bc2c68a10a83338aca6279b96.js integrity="sha256-7EAMVCrgSGqRv4tEbfoaDv7wE4vCxooQqDM4rKYnm5Y=" crossorigin=anonymous></script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script></head><body><header><h1 class=site-title><span role=img aria-label=emoji-logo>üíæ
</span><a href=https://blog.reb.gg/>rob's blog</a></h1><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></nav></header><main><article><h1 class=title>üè° Homelab VI: Terraforming Proxmox</h1><div class=meta><time datetime=2022-01-14T00:00:00-05:00>January 14, 2022</time> &#183; 6 min read</div><div class=tags><a class=tag href=/tags/proxmox/>Proxmox</a>
<a class=tag href=/tags/vm/>Vm</a>
<a class=tag href=/tags/lxc/>Lxc</a>
<a class=tag href=/tags/terraform/>Terraform</a></div><div class=markdown-body><p>In the previous part of this series, I configured a template VM with cloud-init configs for zero intervention VM automation after provision.</p><p>In this part, I&rsquo;ll setup a basic HashiCorp Terraform project for infrastructure as code (IaC) to provision the guest VMs and containers from Proxmox. This will be a great foundation for the homelab, as Terraform can be expanded to cloud automation as well, such as <a href=https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs>managing Cloudflare DNS records</a>.</p><h2 id=what-is-terraform><a href=#what-is-terraform>#</a>
What is Terraform?</h2><p>Terraform is a powerful tool from HashiCorp, they explain it pretty well:</p><blockquote><p>Terraform is an open-source infrastructure as code software tool that provides a consistent CLI workflow to manage hundreds of cloud services. Terraform codifies cloud APIs into declarative configuration files.</p></blockquote><p>(When people mention IaC, 9 times out of 10 it&rsquo;s referring to Terraform.)</p><p>It&rsquo;s an extremely popular tool due to it&rsquo;s easy to learn declarative language (HCL) and extensive <a href=https://registry.terraform.io/browse/providers>cloud provider support</a>. Plus, the entire deployment process is so simple, it&rsquo;s just two commands: <code>terraform plan</code> and <code>terraform apply</code>.</p><h2 id=installing-terraform-locally><a href=#installing-terraform-locally>#</a>
Installing Terraform locally</h2><p>Terraform can be found on most package managers, and they have <a href=https://www.terraform.io/downloads>binaries</a> as well. I&rsquo;ll be placing all of the configuration within a <code>terraform</code> directory on my homelab repository at <a href=https://github.com/robherley/homelab/tree/main/ansible>robherley/homelab</a>.</p><h2 id=creating-an-automation-user><a href=#creating-an-automation-user>#</a>
Creating an automation user</h2><p>Similar to Ansible, an API user for Proxmox will need to be created for Terraform.</p><p>On one of the Proxmox nodes, make a <code>terraform</code> user, add it to the automation group, and set a password:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>pveum user add terraform@pve --groups automation --password &lt;some password&gt;</span></span></code></pre></div><h2 id=provider><a href=#provider>#</a>
Provider</h2><p>There&rsquo;s a <a href=https://registry.terraform.io/providers/Telmate/proxmox/latest/docs>Proxmox provider</a> on the Terraform registry, this&rsquo;ll be the coupling for Terraform to communicate to the Proxmox API and understand how to reconcile the defined Terraform state.</p><p>First, Terrafrom needs to know about the Proxmox provider.</p><p>In <code>terrafrom/main.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span>terraform {
</span></span><span style=display:flex><span>  required_providers {
</span></span><span style=display:flex><span>    <span style=color:#8caaee>proxmox</span> = {
</span></span><span style=display:flex><span>      <span style=color:#8caaee>source</span>  = <span style=color:#a6d189>&#34;telmate/proxmox&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#8caaee>version</span> = <span style=color:#a6d189>&#34;2.9.4&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then, Terraform can be initialized and install the defined plugin:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>terraform init
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing the backend...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Initializing provider plugins...
</span></span><span style=display:flex><span>- Finding telmate/proxmox versions matching <span style=color:#a6d189>&#34;2.9.4&#34;</span>...
</span></span><span style=display:flex><span>- Installing telmate/proxmox v2.9.4...
</span></span><span style=display:flex><span>- Installed telmate/proxmox v2.9.4 <span style=color:#99d1db;font-weight:700>(</span>self-signed, key ID A9EBBE091B35AFCE<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform has been successfully initialized!</span></span></code></pre></div><p>To actually connect Proxmox and Terraform, a provider needs be defined.</p><p>In <code>terraform/providers.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#ca9ee6>provider</span> <span style=color:#a6d189>&#34;proxmox&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>pm_parallel</span>     = <span style=color:#ef9f76>1</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>pm_tls_insecure</span> = <span style=color:#ef9f76>true</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>pm_debug</span>        = <span style=color:#ef9f76>true</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>pm_api_url</span>      = <span style=color:#99d1db>var</span>.pm_api_url
</span></span><span style=display:flex><span>  <span style=color:#8caaee>pm_password</span>     = <span style=color:#99d1db>var</span>.pm_password
</span></span><span style=display:flex><span>  <span style=color:#8caaee>pm_user</span>         = <span style=color:#99d1db>var</span>.pm_user
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is the basic configuration for the provider, most is self explanatory. The <code>pm_parallel</code> command is set to only allow one Proxmox operation at a time.</p><p>The <code>var.*</code> parameters are special, those&rsquo;ll be defined in a variables file.</p><h2 id=variables><a href=#variables>#</a>
Variables</h2><p>Terraform has input variables, which let you customize aspects of Terraform modules without altering the module&rsquo;s own source code. <a href=https://www.terraform.io/language/values/variables>Input variables</a> are declared in blocks within <code>.tf</code> files, and their actual values are in a <code>.tfvars</code> file.</p><p>In <code>terraform/variables.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#ca9ee6>variable</span> <span style=color:#a6d189>&#34;pm_api_url&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>default</span> = <span style=color:#a6d189>&#34;https://192.168.1.100:8006/api2/json&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ca9ee6>
</span></span></span><span style=display:flex><span><span style=color:#ca9ee6>variable</span> <span style=color:#a6d189>&#34;pm_user&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>default</span> = <span style=color:#a6d189>&#34;terraform@pve&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ca9ee6>
</span></span></span><span style=display:flex><span><span style=color:#ca9ee6>variable</span> <span style=color:#a6d189>&#34;pm_password&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>sensitive</span> = <span style=color:#ef9f76>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ca9ee6>
</span></span></span><span style=display:flex><span><span style=color:#ca9ee6>variable</span> <span style=color:#a6d189>&#34;vm_template_name&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>default</span> = <span style=color:#a6d189>&#34;ubuntu-cloudinit-template&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ca9ee6>
</span></span></span><span style=display:flex><span><span style=color:#ca9ee6>variable</span> <span style=color:#a6d189>&#34;lxc_template_name&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>default</span> = <span style=color:#a6d189>&#34;ubuntu-ct-template&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Most of these variable blocks are using <code>default</code>, which makes the variable optional. This is just because I&rsquo;m lazy and I&rsquo;m just defining any public variables here. The <code>pm_password</code> var is <code>sensitive</code> (not shown in Terraform output) with no default, and it will be defined in a <code>.tfvars</code> file that won&rsquo;t be checked into git. As for the <code>*_template_name</code> variables, those&rsquo;ll be used in a bit.</p><p>In <code>terraform/terraform.tfvars</code>, add the <code>terraform</code> Proxmox user password:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#8caaee>pm_password</span> = <span style=color:#a6d189>&#34;correct-horse-battery-staple&#34;</span>
</span></span></code></pre></div><p>Now, the actual resources can be defined. And like anything else in HCL, it&rsquo;s denoted in a block syntax.</p><p>In <code>terraform/resources.tf</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#ca9ee6>resource</span> <span style=color:#a6d189>&#34;proxmox_vm_qemu&#34;</span> <span style=color:#a6d189>&#34;tf-test&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#8caaee>name</span>        = <span style=color:#a6d189>&#34;tf-test&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>target_node</span> = <span style=color:#a6d189>&#34;r720&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>clone</span>       = <span style=color:#99d1db>var</span>.vm_template_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>cores</span>       = <span style=color:#ef9f76>4</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>memory</span>      = <span style=color:#ef9f76>8192</span>
</span></span><span style=display:flex><span>  <span style=color:#8caaee>agent</span>       = <span style=color:#ef9f76>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will create a VM with the name <code>tf-test</code>, which will be a full clone of <code>var.vm_template_name</code> that was defined in <code>variables.tf</code>. Unfortunately unlike the <code>qm clone</code> command, the attributes of the VM are not carried over in this provider&rsquo;s Terraform clone (it&rsquo;s programmed to use defaults instead) so the bare minimal parameters are specified.</p><p>üí° For explanations of all the parameters, see the provider&rsquo;s <a href=https://registry.terraform.io/providers/Telmate/proxmox/latest/docs/resources/vm_qemu#argument-reference>argument reference</a>.</p><p>To plan the change, run <code>terraform plan</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>$ terraform plan
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following
</span></span><span style=display:flex><span>symbols:
</span></span><span style=display:flex><span>  + create
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Terraform will perform the following actions:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#737994;font-style:italic># proxmox_vm_qemu.tf-test will be created</span>
</span></span><span style=display:flex><span>  + resource <span style=color:#a6d189>&#34;proxmox_vm_qemu&#34;</span> <span style=color:#a6d189>&#34;tf-test&#34;</span> <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>additional_wait</span>           <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>0</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>agent</span>                     <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>1</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>automatic_reboot</span>          <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>balloon</span>                   <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>0</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>bios</span>                      <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;seabios&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>boot</span>                      <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;c&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>bootdisk</span>                  <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>clone</span>                     <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;ubuntu-cloudinit-template&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>clone_wait</span>                <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>0</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>cores</span>                     <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>4</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>cpu</span>                       <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;host&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>default_ipv4_address</span>      <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>define_connection_info</span>    <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>force_create</span>              <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>false</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>full_clone</span>                <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>guest_agent_ready_timeout</span> <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>100</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>hotplug</span>                   <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;network,disk,usb&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>id</span>                        <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>kvm</span>                       <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>memory</span>                    <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>8192</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>name</span>                      <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;tf-test&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>nameserver</span>                <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>numa</span>                      <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>false</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>onboot</span>                    <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>false</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>oncreate</span>                  <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>preprovision</span>              <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>reboot_required</span>           <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>scsihw</span>                    <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>searchdomain</span>              <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>sockets</span>                   <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>1</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>ssh_host</span>                  <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>ssh_port</span>                  <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>tablet</span>                    <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>target_node</span>               <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#a6d189>&#34;r720&#34;</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>unused_disk</span>               <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>vcpus</span>                     <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#ef9f76>0</span>
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>vlan</span>                      <span style=color:#99d1db;font-weight:700>=</span> -1
</span></span><span style=display:flex><span>      + <span style=color:#f2d5cf>vmid</span>                      <span style=color:#99d1db;font-weight:700>=</span> <span style=color:#99d1db;font-weight:700>(</span>known after apply<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...</span></span></code></pre></div><p>Once the plan is confirmed to be okay, it can be applied:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>$ terraform apply
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Creating...
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Still creating... <span style=color:#99d1db;font-weight:700>[</span>10s elapsed<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Still creating... <span style=color:#99d1db;font-weight:700>[</span>20s elapsed<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Still creating... <span style=color:#99d1db;font-weight:700>[</span>30s elapsed<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Still creating... <span style=color:#99d1db;font-weight:700>[</span>40s elapsed<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Still creating... <span style=color:#99d1db;font-weight:700>[</span>50s elapsed<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Still creating... <span style=color:#99d1db;font-weight:700>[</span>1m0s elapsed<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>proxmox_vm_qemu.tf-test: Creation <span style=color:#99d1db>complete</span> after 1m3s <span style=color:#99d1db;font-weight:700>[</span><span style=color:#f2d5cf>id</span><span style=color:#99d1db;font-weight:700>=</span>r720/qemu/101<span style=color:#99d1db;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply complete! Resources: <span style=color:#ef9f76>1</span> added, <span style=color:#ef9f76>0</span> changed, <span style=color:#ef9f76>0</span> destroyed.</span></span></code></pre></div><p>Now to double check with Ansible:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible proxmox_all_running -m ping
</span></span><span style=display:flex><span>tf-test | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span></span></span></code></pre></div><p>Perfect! The homelab infrastructure is now fully declarative and automated.</p><p>‚ùó<strong>Note:</strong> during testing, I have found the provider to be flaky at points when determining if the VM or LXC is created or not. Apparently this is a <a href=https://github.com/Telmate/terraform-provider-proxmox/issues/480#issuecomment-1005949219>known issue</a> with the provider, due to a bug when interacting with Proxmox conf locks. Either the provider can be downgraded to version <code>2.8.0</code> or existing resources can be imported into Terraform&rsquo;s state like so:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#737994;font-style:italic># terraform import &lt;resource type&gt;.&lt;resource name&gt; &lt;node&gt;/&lt;type&gt;/&lt;vmid&gt;</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>terraform import proxmox_vm_qemu.tf-test r720/qemu/101</span></span></code></pre></div><h2 id=conclusion><a href=#conclusion>#</a>
Conclusion</h2><p>Well, that&rsquo;s it for the homelab series! I think six parts is enough to conclude. The homelab is now a fully operational virtualization cluster with redundant ZFS (and NFS) storage, VM/LXC templates, automated with Ansible and provisioned via IaC with Terraform. There <em>may</em> be separate one-offs for TrueNAS, Kubernetes or OpenShift clusters, but no promises. Thanks for tagging along!</p></div></article><div class=prev-next><div><a href=https://blog.reb.gg/posts/05-homelab-pt5/>&#8592; Prev</a>
<span>üè° Homelab V: Proxmox VMs and cloud-init</span></div><div><a style=align-self:flex-end href=https://blog.reb.gg/posts/07-go-tiny-coffee/>Next &#8594;</a>
<span>‚òï Rewriting tiny.coffee to &lt; 100 lines ‚Ä¶</span></div></div></main><footer><div class=stripes></div><div class=footer-meta><div><div>2024 Rob Herley</div><div>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> &
      <a href=https://github.com/robherley/rebugo target=_blank rel="noopener noreferrer">robherley/rebugo</a></div></div><div class=socials><a href=https://github.com/robherley rel=author title=github><i class="si si-github"></i></a><a href=https://x.com/robherley rel=author title=x><i class="si si-x"></i></a><a href=https://instagram.com/robherley rel=author title=instagram><i class="si si-instagram"></i></a><a href=https://www.linkedin.com/in/robherley/ rel=author title=linkedin><i class="si si-linkedin"></i></a></div></div></footer></body></html>