<!doctype html><html lang=en>
<head>
<title>
Homelab Part I: Intro, Hardware and Proxmox install ::
rob's blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="👋 Hey y&amp;rsquo;all, welcome to the start of my homelab (or, the latest iteration of it). I&amp;rsquo;m documenting my homelab setup as a helpful guide for others to learn, detailing some of the annoying issues I encountered and some of the duct tape solutions. These are also backup instructions for when I inevitably scrap this homelab, rebuild, and forget how I did everything.
This series will be centered around the setup and automation of a Promox cluster comprised of three very different machines.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://blog.reb.gg/posts/01-homelab-pt1/>
<link rel=stylesheet href=https://blog.reb.gg/assets/style.css>
<link rel=stylesheet href=https://blog.reb.gg/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://blog.reb.gg/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://blog.reb.gg/img/favicon.png>
<link href=https://blog.reb.gg/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://blog.reb.gg/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://blog.reb.gg/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://blog.reb.gg/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://blog.reb.gg/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://blog.reb.gg/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Homelab Part I: Intro, Hardware and Proxmox install">
<meta name=twitter:description content="👋 Hey y&rsquo;all, welcome to the start of my homelab (or, the latest iteration of it). I&rsquo;m documenting my homelab setup as a helpful guide for others to learn, detailing some of the annoying issues I encountered and some of the duct tape solutions. These are also backup instructions for when I inevitably scrap this homelab, rebuild, and forget how I did everything.
This series will be centered around the setup and automation of a Promox cluster comprised of three very different machines.">
<meta property="og:title" content="Homelab Part I: Intro, Hardware and Proxmox install">
<meta property="og:description" content="👋 Hey y&rsquo;all, welcome to the start of my homelab (or, the latest iteration of it). I&rsquo;m documenting my homelab setup as a helpful guide for others to learn, detailing some of the annoying issues I encountered and some of the duct tape solutions. These are also backup instructions for when I inevitably scrap this homelab, rebuild, and forget how I did everything.
This series will be centered around the setup and automation of a Promox cluster comprised of three very different machines.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.reb.gg/posts/01-homelab-pt1/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-09T01:00:00-05:00">
<meta property="article:modified_time" content="2022-01-09T01:00:00-05:00"><meta property="og:site_name" content="rob's blog">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>rob's blog</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>Homelab Part I: Intro, Hardware and Proxmox install</h1>
<div class=post-meta>
<span class=post-date>
2022-01-09
</span>
<span class=post-read-time>— 6 min read</span>
</div>
<div class=post-content>
<p>👋 Hey y&rsquo;all, welcome to the start of my homelab (or, the latest iteration of it). I&rsquo;m documenting my homelab setup as a helpful guide for others to learn, detailing some of the annoying issues I encountered and some of the duct tape solutions. These are also backup instructions for when I inevitably scrap this homelab, rebuild, and forget how I did everything.</p>
<p>This series will be centered around the setup and automation of a Promox cluster comprised of three very different machines. The virtualization cluster will house a variety of workloads, including:</p>
<ul>
<li>Kubernetes/OpenShift cluster(s)</li>
<li>Media servers (<a href=https://jellyfin.org/>Jellyfin</a>)</li>
<li>Network attached storage (<a href=https://www.truenas.com/truenas-scale/>TrueNAS Scale</a>)</li>
<li>Adblocker (<a href=https://pi-hole.net/>Pi-hole</a>)</li>
<li>Proxy servers, web apps, minecraft and more</li>
</ul>
<p>The goal is to keep the hosts as appliance-like as possible, and have most actions reproducable via automation. All of the relevant code will be available on <a href=https://github.com/robherley/homelab>robherley/homelab</a>, feel free to contribute.</p>
<p>In this first part, I&rsquo;ll go over the hardware, some minor hacks, and the initial baremetal Proxmox install.</p>
<h2 id=hardware>Hardware</h2>
<p><img src=/homelab/rack.png alt=Rack></p>
<h3 id=dell-poweredge-r720xdhttpswwwdellcomen-usworkshopproductdetailstxnpoweredge-r720xd><a href=https://www.dell.com/en-us/work/shop/productdetailstxn/poweredge-r720xd>Dell Poweredge r720xd</a></h3>
<ul>
<li><strong>CPU:</strong> 2 x Intel Xeon (16) @ 2.50GHz</li>
<li><strong>Memory:</strong> 16 x Kingston 8GB DDR3-1600</li>
<li><strong>Storage:</strong>
<ul>
<li>1 x SATA Samsung Evo 850 500GB SSD</li>
<li>2 x SATA Crucial MX500 1TB SSD</li>
<li>9 x SATA Seagate Constellation 1TB HDD</li>
<li>2 x SAS Seagate Constellation 1TB HDD</li>
</ul>
</li>
</ul>
<h3 id=intel-nuci7behhttpswwwintelcomcontentwwwusenproductssku126140intel-nuc-kit-nuc8i7behspecificationshtml><a href=https://www.intel.com/content/www/us/en/products/sku/126140/intel-nuc-kit-nuc8i7beh/specifications.html>Intel NUCi7BEH</a></h3>
<ul>
<li><strong>CPU:</strong> Intel i7-8559U (8) @ 4.50GHz</li>
<li><strong>Memory:</strong> Mixed 32GB (16x2) DDR4-2666</li>
<li><strong>Storage:</strong>
<ul>
<li>Crucial m.2 1TB SSD</li>
</ul>
</li>
</ul>
<h3 id=intel-2000-family-jbodhttpswwwintelcomcontentdamsupportusendocumentsserver-productsserver-systemsjbod20hwg_v142pdf><a href=https://www.intel.com/content/dam/support/us/en/documents/server-products/server-systems/JBOD%20HWG_v.1.42.pdf>Intel 2000 Family JBOD</a></h3>
<ul>
<li>Connected to r720xd via Intel LSI HBA.</li>
<li><strong>Storage:</strong> (Total capacity of 12 drives)
<ul>
<li>4 x Seagate IronWolf 4TB NAS HDD</li>
</ul>
</li>
</ul>
<h3 id=raspberry-pi-3-model-bhttpswwwraspberrypicomproductsraspberry-pi-3-model-b><a href=https://www.raspberrypi.com/products/raspberry-pi-3-model-b/>Raspberry Pi 3 Model B</a></h3>
<ul>
<li><strong>CPU:</strong> Quad Core 1.2GHz Broadcom BCM2837</li>
<li><strong>Memory:</strong> 1GB RAM</li>
<li><strong>Storage:</strong>
<ul>
<li>8GB Micro SDHC</li>
</ul>
</li>
</ul>
<h3 id=rack-components>Rack Components</h3>
<ul>
<li><a href=https://www.startech.com/en-us/server-management/4postrack12u>Startech 12U rack</a></li>
<li><a href=https://www.amazon.com/dp/B00006B83A>Tripp Lite 1U Surge Protector</a></li>
<li><a href=https://www.amazon.com/dp/B008X3JHJQ>StarTech 2U Shelf</a></li>
<li><a href=https://www.amazon.com/dp/B0060RUVBA>StartTech 1U Rails</a></li>
</ul>
<h3 id=networking>Networking</h3>
<p>Unfortunately, I do not have dedicated networking hardware yet. I&rsquo;m using the <a href=https://www.verizon.com/home/accessories/fios-router/>Verizon G3100</a> for now. The Raspberry Pi is running <a href=https://pi-hole.net/>Pi-hole</a> for custom DNS and it also handles DHCP.</p>
<h2 id=hacks>Hacks</h2>
<h3 id=flashing-raid-controller>Flashing RAID controller</h3>
<p>For my homelab I decided to use ZFS, a software-based RAID. Unfortunately, the included controller with the Poweredge r720xd is expecting to always use a hardware RAID-based virtual disk setup. In order to force the included RAID controller to allow individual use of each disk, it needs to be flashed into IT mode. Fortunately, the folks at <a href=https://fohdeesha.com/docs/perc.html>Fohdeesha</a> have amazing guides for flashing the firmware on all kinds of RAID controllers, including the PERC H710 in this r720xd. After disconnecting the RAID battery, live booting into DOS and Linux images and few shell commands, I was ready to go.</p>
<h3 id=lsi-and-seagate-headache>LSI and Seagate headache</h3>
<p>Luckily, the Intel branded LSI controller used as an HBA can be configured in JBOD mode, so it did not require any flashing to connect the r720xd and the Seagate drives. But, when testing some zpools I noticed a tremendous amount of <code>blk_update_request</code> I/O errors from the kernel. Turns out, there&rsquo;s a spinup/down issue with the Seagate Ironwolf drives and some LSI controllers. Specifically when the disks go into standby mode there are some delays for them to spin up, resulting in the <code>blk_update_request</code> I/O errors I was seeing in the kernel.</p>
<p>First fix attempt was to force some settings in <a href=https://wiki.archlinux.org/title/Hdparm><code>hdparm</code></a>:</p>
<ul>
<li>disabling the standby timeout (<code>hdparm -S 0 &lt;disk></code>)</li>
<li>disabling the advance power management setting (<code>hdparm -B 255 &lt;disk></code>).</li>
</ul>
<p>In addition, Seagate has a special drive utility called SeaChest, I followed <a href=https://forums.unraid.net/topic/103938-69x-lsi-controllers-ironwolf-disks-disabling-summary-fix/>this guide</a>
from a user on the Unraid forum. Within that guide, there&rsquo;ll be instructions to disable EPC and low current spinup, which helped users resolve the drive issues.</p>
<h3 id=loud-jbod>Loud JBOD</h3>
<p>This entire rack is next to my desk, so reducing the amount of noise it makes is pretty important. At idle, the r720xd is suprisingly quiet, whereas the Intel JBOD consistently sounds like a jet engine. So, I grabbed my soldering iron, some wire cutters and three of Noctua&rsquo;s <a href=https://noctua.at/en/nf-a6x25-pwm>NF-A6x25</a>&rsquo;s. It was a relatively painless replacement, and the rubberized feet on the fans gave them a nice friction fit. They have roughly the same size, PWM layout and voltage as the stock Nidec Ultraflo fans. But, they have noticibly less airflow. Fortunately with only four drives in the JBOD they manage to stay nice and cool.</p>
<p><img src=/homelab/jbod_fans.png alt="JBOD fan replacement"></p>
<h3 id=drive-caddies>Drive caddies</h3>
<p>I didn&rsquo;t have any extra of the OEM Dell drive caddies for the three SSDs I&rsquo;m installing into the poweredge. Luckily, <a href=https://www.thingiverse.com/thing:2491236/>someone on thingiverse</a> made these really sweet models that resememble mini versions of the poweredge. They are sturdy enough to reliably hold the SSDs in place, but I would recommend them for spinning rust.</p>
<p><img src=/homelab/caddies.png alt="3D Printed Caddies"></p>
<h2 id=storage-overview>Storage overview</h2>
<p>For redundancy, most of the homelab storage will be using ZFS. The YouTube channel Level1Techs has an <a href="https://www.youtube.com/watch?v=uBfXdJGmWoM">amazing breakdown</a> on ZFS and software RAID in general.</p>
<h3 id=nuc>NUC</h3>
<h4 id=1tb-ssd---host-os--guest-vms>1TB SSD - Host OS & Guest VMs</h4>
<p>Since storage options are pretty limited in the NUC, it is just using a single 1TB m.2 SSD shared for both the host OS and guest VMs. Eventually, I would like to squeeze add an additional 1TB SATA ssd for mirror ZFS, but this is fine for now. Backups for guest VMs on this single drive will be on network storage.</p>
<h3 id=r720>r720</h3>
<h4 id=500gb-ssd---host-os>500GB SSD - Host OS</h4>
<p>I&rsquo;m just using a single 500GB SSD for the host proxmox OS. This drive can be even smaller, but it was what I had laying around. Ideally this would also be a mirrored setup but a single drive is fine for now. In the event of this drive failing, I&rsquo;ll just swap it out, reinstall OS, run Ansible and/or restore from backups. For me personally, redundacy for the host OS isn&rsquo;t as critical for the VM guests and network storage.</p>
<h4 id=ssd-mirror---zfs-mirror-of-2x-1tb-crucial-ssds><code>ssd-mirror</code> - ZFS mirror of 2x 1TB Crucial SSDs</h4>
<p>These are the fastest drives I have, so all the guest VM disk images will be on here. It&rsquo;s a mirror, so I can quickly recover from one of these drives failing.</p>
<h4 id=rusty-z2---zfs-raidz2-of-11x-1tb-seagate-enterprise-constellations><code>rusty-z2</code> - ZFS RAIDz2 of 11x 1TB Seagate enterprise constellations</h4>
<p>This pool is slower, so it&rsquo;s used for all VM backups from the <code>ssd-mirror</code> pool and the backups from the NUC vm&rsquo;s over NFS. Note the <code>z2</code>, I have two parity drives in this pool, since these drives are a bit older and have more use.</p>
<h4 id=wolves-z---zfs-raidz-of-4x-4tb-seagate-ironwolf-nas><code>wolves-z</code> - ZFS RAIDz of 4x 4TB Seagate Ironwolf NAS</h4>
<p>This&rsquo;ll be primarily for media storage and other network attached storage. In fact, the entire controller for these disks (the HBA connected to JBOD) will be passed through to the TrueNAS guest. These drives are a nice compromise of speed, capacity and cost. Note the <code>z</code>, this pool has a single parity drive.</p>
<h2 id=proxmox-setup>Proxmox setup</h2>
<h3 id=installation>Installation</h3>
<p>Proxmox will be installed on both the Poweredge and the NUC. The Pi is going to have a different process since it will only be used for quorum, so it&rsquo;ll be using <a href=https://www.raspberrypi.com/software/>Raspberry Pi OS</a>. The Proxmox installer is pretty straightforward, just write the ISO to a USB, boot into the installer, pick a root disk, setup user credentials and set a static IP. Here are some tutorials by awesome homelab YouTube channels:</p>
<ul>
<li>TechnoTim: <a href="https://www.youtube.com/watch?v=7OVaWaqO2aU">Proxmox VE Install and Setup Tutorial</a></li>
<li>Craft Computing: <a href="https://www.youtube.com/watch?v=azORbxrItOo">Virtualize Everything! - Proxmox Install Tutorial</a></li>
</ul>
<p>After installation, the Proxmox web console is available at <code>https://&lt;host-ip>:8006</code>. For the sake of keeping these machines as pristine as possible, I&rsquo;m going to attempt to do the bare minimal configuration post-install and then use <a href=https://www.ansible.com/>Ansible</a> to further patches the hosts.</p>
<h2 id=next>Next</h2>
<p>The base operating systems are configured, but right now they&rsquo;re independent systems. In the next part, I&rsquo;ll setup a two node Proxmox cluster with a quorum devices, setup ZFS pools for redundancy and some basic network storage.</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://blog.reb.gg/posts/02-homelab-pt2/>
<span class=button__icon>←</span>
<span class=button__text>Homelab Part II: Proxmox cluster, ZFS and NFS</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>rob's blog</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://blog.reb.gg/assets/main.js></script>
<script src=https://blog.reb.gg/assets/prism.js></script>
</div>
</body>
</html>