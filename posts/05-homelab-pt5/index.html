<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>üè° Homelab V: Proxmox VMs and cloud-init | rob's blog</title><link rel=icon type=image/png href=https://blog.reb.gg/images/logo.png><meta property="og:url" content="https://blog.reb.gg/posts/05-homelab-pt5/">
<meta property="og:site_name" content="rob's blog"><meta property="og:title" content="üè° Homelab V: Proxmox VMs and cloud-init"><meta property="og:description" content="In the previous part of this series, I setup a Proxmox dynamic inventory with Ansible and created a basic LXC template for creating containers that were automation ready.
In this part, I‚Äôll setup some cloud-init configs to initalize VMs in a state where they can automatically be managed by Ansible.
# Cloud Images While it‚Äôs possible to prepare custom base images for cloud-init, many Linux distributions already provide ready-to-use images, such as Ubuntu, Fedora, Debian, etc. This allows for a (mostly) unified configuration that can work across distros and even some *BSD variants."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-13T00:00:00-05:00"><meta property="article:modified_time" content="2022-01-13T00:00:00-05:00"><meta property="article:tag" content="Proxmox"><meta property="article:tag" content="Vm"><meta property="article:tag" content="Cloud-Init"><meta name=twitter:card content="summary"><meta name=twitter:title content="üè° Homelab V: Proxmox VMs and cloud-init"><meta name=twitter:description content="In the previous part of this series, I setup a Proxmox dynamic inventory with Ansible and created a basic LXC template for creating containers that were automation ready.
In this part, I‚Äôll setup some cloud-init configs to initalize VMs in a state where they can automatically be managed by Ansible.
# Cloud Images While it‚Äôs possible to prepare custom base images for cloud-init, many Linux distributions already provide ready-to-use images, such as Ubuntu, Fedora, Debian, etc. This allows for a (mostly) unified configuration that can work across distros and even some *BSD variants."><link rel=stylesheet href=/css/custom.min.faefcaabf97ea44e2b9626162349aeb966c6ea5166b9d744503b93cdd81173ad.css integrity="sha256-+u/Kq/l+pE4rliYWI0muuWbG6lFmuddEUDuTzdgRc60=" crossorigin=anonymous><link rel=stylesheet href=/css/article.min.3d68b337d54382250563c3c74528261d25b316f1df232ec198665d91e6621ba7.css integrity="sha256-PWizN9VDgiUFY8PHRSgmHSWzFvHfIy7BmGZdkeZiG6c=" crossorigin=anonymous><link rel=stylesheet href=/css/fonts.min.e0bf373169e09cf6dfc780f970638fcd39a5898dcecb6c9286f170d5907dbbf5.css integrity="sha256-4L83MWngnPbfx4D5cGOPzTmliY3Oy2yShvFw1ZB9u/U=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.61771936e5acd378a831a0ce3858ec58f08eeb0598159d8d3477988eb62c02ee.css integrity="sha256-YXcZNuWs03ioMaDOOFjsWPCO6wWYFZ2NNHeYjrYsAu4=" crossorigin=anonymous><link rel=stylesheet href=/css/simple-icons.min.min.8e53216f6540542c220ed40839d164fb18b299e5d70551cb60b0600d3f0a011f.css integrity="sha256-jlMhb2VAVCwiDtQIOdFk+xiymeXXBVHLYLBgDT8KAR8=" crossorigin=anonymous><style>:root{--color-primary:var(--color-blue-6)}</style><script src=/js/main.95176a6398aade31e73736833a061caca263c49d5f1e01d192b9e651423e0f8c.js integrity="sha256-lRdqY5iq3jHnNzaDOgYcrKJjxJ1fHgHRkrnmUUI+D4w=" crossorigin=anonymous></script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script><script defer data-domain=blog.reb.gg src=https://a.reb.gg/js/script.js></script></head><body><header><h1 class=site-title><span role=img aria-label=emoji-logo>üíæ
</span><a href=https://blog.reb.gg/>rob's blog</a></h1><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></nav></header><main><article><h1 class=title>üè° Homelab V: Proxmox VMs and cloud-init</h1><div class=meta><time datetime=2022-01-13T00:00:00-05:00>January 13, 2022</time> &#183; 4 min read</div><div class=tags><a class=tag href=/tags/proxmox/>Proxmox</a>
<a class=tag href=/tags/vm/>Vm</a>
<a class=tag href=/tags/cloud-init/>Cloud-Init</a></div><div class=markdown-body><p>In the previous part of this series, I setup a Proxmox dynamic inventory with Ansible and created a basic LXC template for creating containers that were automation ready.</p><p>In this part, I&rsquo;ll setup some <a href=https://cloudinit.readthedocs.io/en/latest/>cloud-init</a> configs to initalize VMs in a state where they can automatically be managed by Ansible.</p><h2 id=cloud-images><a href=#cloud-images>#</a>
Cloud Images</h2><p>While it&rsquo;s possible to prepare custom base images for cloud-init, many Linux distributions already provide ready-to-use images, such as <a href=https://cloud-images.ubuntu.com>Ubuntu</a>, <a href=https://alt.fedoraproject.org/cloud/>Fedora</a>, <a href=https://cloud.debian.org/images/cloud/>Debian</a>, etc. This allows for a (mostly) unified configuration that can work across distros and even some *BSD variants.</p><p>Pull a cloud image to storage:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span><span style=color:#99d1db>cd</span> /tmp
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>wget https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img</span></span></code></pre></div><p>Alternatively, the <a href=https://cloudinit.readthedocs.io/en/latest/topics/cli.html#cli-interface><code>cloud-init</code></a> CLI can be used to build custom images.</p><h2 id=template-vm><a href=#template-vm>#</a>
Template VM</h2><p>Similar to the process for LXC, image templates will be used for VM creation. But unlike containers, it is not necessary to boot into the VM and manually tweak the environment. The first-time setup can all be done with cloud-init. The <a href=https://pve.proxmox.com/wiki/Cloud-Init_Support>Proxmox wiki</a> has some examples, although the documentation is a bit sparse.</p><p>First, create the VM using the <a href=https://pve.proxmox.com/pve-docs/qm.1.html><code>qm</code></a> CLI:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm create <span style=color:#ef9f76>2000</span> <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--name ubuntu-cloudinit-template <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--net0 virtio,bridge<span style=color:#99d1db;font-weight:700>=</span>vmbr0 <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--memory <span style=color:#ef9f76>8192</span> <span style=color:#8caaee>\
</span></span></span><span style=display:flex><span><span style=color:#8caaee></span>--cores <span style=color:#ef9f76>4</span></span></span></code></pre></div><p>Import the cloud image downloaded earlier (or use a custom one), attach it to the VM, and resize as necessary:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm importdisk <span style=color:#ef9f76>2000</span> /tmp/focal-server-cloudimg-amd64.img ssd-mirror --format qcow2
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --scsihw virtio-scsi-pci --scsi0 ssd-mirror:vm-2000-disk-0
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm resize <span style=color:#ef9f76>2000</span> scsi0 +32G <span style=color:#737994;font-style:italic># increase it by 32GB</span></span></span></code></pre></div><p>Add a CDROM drive for cloud-init, and restrict BIOS to boot from disk only to speed up the boot process:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --ide2 ssd-mirror:cloudinit
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --boot c --bootdisk scsi0</span></span></code></pre></div><p>It is recommended to attach a serial console to the VM as well:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --serial0 socket --vga serial0</span></span></code></pre></div><p>And also enable the guest agent which will be installed later by cloud-init:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@r720 qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --agent <span style=color:#ef9f76>1</span></span></span></code></pre></div><h2 id=cloud-config><a href=#cloud-config>#</a>
Cloud config</h2><p>With the VM ready, it&rsquo;s time to tweak the cloud config. Proxmox autogenerates configs for the <a href=https://cloudinit.readthedocs.io/en/latest/topics/examples.html><code>user</code></a>, <a href=https://cloudinit.readthedocs.io/en/latest/topics/network-config.html><code>network</code></a>, and <a href=https://cloudinit.readthedocs.io/en/latest/topics/instancedata.html><code>meta</code></a> types, they can be inspected like so:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm cloudinit dump <span style=color:#ef9f76>2000</span> user <span style=color:#737994;font-style:italic># or `network` or `meta`</span>
</span></span><span style=display:flex><span><span style=color:#737994;font-style:italic>#cloud-config</span>
</span></span><span style=display:flex><span>hostname: ubuntu-cloudinit-template
</span></span><span style=display:flex><span>manage_etc_hosts: <span style=color:#99d1db>true</span>
</span></span><span style=display:flex><span>chpasswd:
</span></span><span style=display:flex><span>  expire: False
</span></span><span style=display:flex><span>users:
</span></span><span style=display:flex><span>  - default
</span></span><span style=display:flex><span>package_upgrade: true</span></span></code></pre></div><p>In my opinion, the way Proxmox template cloud config is a bit backwards. Instead of autogenerating <a href=https://cloudinit.readthedocs.io/en/latest/topics/vendordata.html><code>vendor</code></a> data, Proxmox uses the <code>user</code> data. This is slightly annoying because if a custom <code>user</code> configuration YAML is attached, it is impossible to have the config autoassign the hostname based on the VM name. Unfortunately, to change the default configuration template it is relatively limited. For any complicated cloud config, I&rsquo;ll abuse <code>vendor</code> instead. But, it is worth noting that <code>user</code> config takes precedence over <code>vendor</code>, so any values defined in <code>user</code> will not be overwritten.</p><p>üí° Custom cloud configs files are stored under the <code>snippets</code> type.</p><p>In <code>/rusty-z2/pve/snippets/ubuntu-qemu.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#737994;font-style:italic>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>user</span>: rob
</span></span><span style=display:flex><span><span style=color:#ca9ee6>password</span>: $6$himalayan$E.K7G4g7NoIW69HLpmK1QDU1JMN4aaSYPOOGX1SwoSl.uqr64JruCEeDH0nLi9CxJR1/2HGTnTDVKfCC2ubub1
</span></span><span style=display:flex><span><span style=color:#ca9ee6>ssh_import_id</span>:
</span></span><span style=display:flex><span>  - gh:robherley
</span></span><span style=display:flex><span><span style=color:#ca9ee6>packages</span>:
</span></span><span style=display:flex><span>  - qemu-guest-agent
</span></span></code></pre></div><p>This will be doing mostly the same prep work as the container process. It will:</p><ul><li>Overwrite the default user&rsquo;s name as <code>rob</code>. This user will also implicitly get an entry in <code>/etc/sudoers.d/90-cloud-init-users</code> for passwordless sudo.</li><li>Run <code>ssh-import-id</code> to pull public keys from GitHub.</li><li>Add <code>qemu-guest-agent</code>, a helper daemon used to exchange information between the host and guest.</li></ul><p>Add the <code>vendor</code> cloud config to the template VM:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --cicustom <span style=color:#a6d189>&#34;vendor=rusty-dir:snippets/ubuntu-qemu.yaml&#34;</span></span></span></code></pre></div><p>The network config also needs a slight tweak to use DHCP:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm <span style=color:#99d1db>set</span> <span style=color:#ef9f76>2000</span> --ipconfig0 <span style=color:#f2d5cf>ip</span><span style=color:#99d1db;font-weight:700>=</span>dhcp</span></span></code></pre></div><p>And finally, set the VM to be a template:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm template <span style=color:#ef9f76>2000</span></span></span></code></pre></div><p>To test, just clone some VMs from the template:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm clone <span style=color:#ef9f76>2000</span> <span style=color:#ef9f76>101</span> --full --name thing1
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm clone <span style=color:#ef9f76>2000</span> <span style=color:#ef9f76>102</span> --full --name thing2
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm start <span style=color:#ef9f76>101</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>qm start <span style=color:#ef9f76>102</span></span></span></code></pre></div><p>These take a bit longer than the containers to spin up, and they need to run through the cloud-init process after boot. After waiting a while, they should be reachable:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>ansible proxmox_all_running -m ping
</span></span><span style=display:flex><span>thing2 | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>thing1 | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span></span></span></code></pre></div><p><strong>Note:</strong> For the qemu-guest-agent to be detected by Proxmox, the VM needs to be stopped by Proxmox (or <code>qm</code> CLI) and restarted.</p><h2 id=next><a href=#next>#</a>
Next</h2><p>Automation-ready virtual machine and containers can now be programmatically created. Using the CLI can be a bit of a pain and the web console is fine for one-offs, but this process can be improved with a wonderful tool from HashiCorp called Terraform. In the next part of the series, Terraform will be used as IaC to provision the guests from Proxmox.</p></div></article><div class=prev-next><div><a href=https://blog.reb.gg/posts/04-homelab-pt4/>&#8592; Prev</a>
<span>üè° Homelab IV: Proxmox Dynamic Inventory ‚Ä¶</span></div><div><a style=align-self:flex-end href=https://blog.reb.gg/posts/06-homelab-pt6/>Next &#8594;</a>
<span>üè° Homelab VI: Terraforming Proxmox</span></div></div></main><footer><div class=stripes></div><div class=footer-meta><div><div>2024 Rob Herley</div><div>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> &
      <a href=https://github.com/robherley/rebugo target=_blank rel="noopener noreferrer">robherley/rebugo</a></div></div><div class=socials><a href=https://github.com/robherley rel=author title=github><i class="si si-github"></i></a><a href=https://x.com/robherley rel=author title=x><i class="si si-x"></i></a><a href=https://instagram.com/robherley rel=author title=instagram><i class="si si-instagram"></i></a><a href=https://www.linkedin.com/in/robherley/ rel=author title=linkedin><i class="si si-linkedin"></i></a></div></div></footer></body></html>