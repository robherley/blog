<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>üè° Homelab III: Automation with Ansible and Hardening Access | rob's blog</title><link rel=icon type=image/png href=https://blog.reb.gg/images/logo.png><meta property="og:url" content="https://blog.reb.gg/posts/03-homelab-pt3/">
<meta property="og:site_name" content="rob's blog"><meta property="og:title" content="üè° Homelab III: Automation with Ansible and Hardening Access"><meta property="og:description" content="In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I‚Äôll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This‚Äôll all be through an automatic, idempotent configuration process.
# What is Ansible? Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it‚Äôs an extremely popular tool making it a great learning exercise for the homelab. It has an agentless architecture, so it‚Äôs super simple to setup only requiring an SSH connection. I‚Äôll use my laptop to manage Ansible to the controlled machines. In a ‚Äúreal world‚Äù environment, this would typically be done on a bastion."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-11T00:00:00-05:00"><meta property="article:modified_time" content="2022-01-11T00:00:00-05:00"><meta property="article:tag" content="Proxmox"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="Ssh"><meta name=twitter:card content="summary"><meta name=twitter:title content="üè° Homelab III: Automation with Ansible and Hardening Access"><meta name=twitter:description content="In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I‚Äôll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This‚Äôll all be through an automatic, idempotent configuration process.
# What is Ansible? Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it‚Äôs an extremely popular tool making it a great learning exercise for the homelab. It has an agentless architecture, so it‚Äôs super simple to setup only requiring an SSH connection. I‚Äôll use my laptop to manage Ansible to the controlled machines. In a ‚Äúreal world‚Äù environment, this would typically be done on a bastion."><link rel=stylesheet href=/css/custom.min.faefcaabf97ea44e2b9626162349aeb966c6ea5166b9d744503b93cdd81173ad.css integrity="sha256-+u/Kq/l+pE4rliYWI0muuWbG6lFmuddEUDuTzdgRc60=" crossorigin=anonymous><link rel=stylesheet href=/css/article.min.3d68b337d54382250563c3c74528261d25b316f1df232ec198665d91e6621ba7.css integrity="sha256-PWizN9VDgiUFY8PHRSgmHSWzFvHfIy7BmGZdkeZiG6c=" crossorigin=anonymous><link rel=stylesheet href=/css/fonts.min.e0bf373169e09cf6dfc780f970638fcd39a5898dcecb6c9286f170d5907dbbf5.css integrity="sha256-4L83MWngnPbfx4D5cGOPzTmliY3Oy2yShvFw1ZB9u/U=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.61771936e5acd378a831a0ce3858ec58f08eeb0598159d8d3477988eb62c02ee.css integrity="sha256-YXcZNuWs03ioMaDOOFjsWPCO6wWYFZ2NNHeYjrYsAu4=" crossorigin=anonymous><link rel=stylesheet href=/css/simple-icons.min.min.8e53216f6540542c220ed40839d164fb18b299e5d70551cb60b0600d3f0a011f.css integrity="sha256-jlMhb2VAVCwiDtQIOdFk+xiymeXXBVHLYLBgDT8KAR8=" crossorigin=anonymous><style>:root{--color-primary:var(--color-blue-6)}</style><script src=/js/main.95176a6398aade31e73736833a061caca263c49d5f1e01d192b9e651423e0f8c.js integrity="sha256-lRdqY5iq3jHnNzaDOgYcrKJjxJ1fHgHRkrnmUUI+D4w=" crossorigin=anonymous></script><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script><script defer data-domain=blog.reb.gg src=https://a.reb.gg/js/script.js></script></head><body><header><h1 class=site-title><span role=img aria-label=emoji-logo>üíæ
</span><a href=https://blog.reb.gg/>rob's blog</a></h1><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li></ul></nav></header><main><article><h1 class=title>üè° Homelab III: Automation with Ansible and Hardening Access</h1><div class=meta><time datetime=2022-01-11T00:00:00-05:00>January 11, 2022</time> &#183; 8 min read</div><div class=tags><a class=tag href=/tags/proxmox/>Proxmox</a>
<a class=tag href=/tags/ansible/>Ansible</a>
<a class=tag href=/tags/ssh/>Ssh</a></div><div class=markdown-body><p>In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I&rsquo;ll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This&rsquo;ll all be through an automatic, idempotent configuration process.</p><h2 id=what-is-ansible><a href=#what-is-ansible>#</a>
What is Ansible?</h2><p>Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it&rsquo;s an extremely popular tool making it a great learning exercise for the homelab. It has an agentless architecture, so it&rsquo;s super simple to setup only requiring an SSH connection. I&rsquo;ll use my laptop to manage Ansible to the controlled machines. In a &ldquo;real world&rdquo; environment, this would typically be done on a <a href=https://en.wikipedia.org/wiki/Bastion_host>bastion</a>.</p><h2 id=installing-ansible-locally><a href=#installing-ansible-locally>#</a>
Installing Ansible locally</h2><p>Ansible can most likely be found on <a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-on-specific-operating-systems>your favorite package manager</a>, but it can also be installed via <a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-and-upgrading-ansible-with-pip><code>pip</code></a>. We&rsquo;ll be making <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html>playbooks</a> to handle some of the automation of our homelab.</p><h2 id=adding-ssh-keys-for-controlled-access><a href=#adding-ssh-keys-for-controlled-access>#</a>
Adding SSH keys for controlled access</h2><p>Since Ansible is agentless and uses SSH, each machine will need minor config changes for the initial access. Using password authentication for SSH generally isn&rsquo;t a good idea, so SSH key verification will be used. The <a href=http://manpages.ubuntu.com/manpages/focal/man1/ssh-import-id.1.html><code>ssh-import-id</code></a> utility is great for this, it can pull public keys from sources like <a href=https://github.com/>GitHub</a> or <a href=https://launchpad.net/>Canonical Launchpad</a> and add them to an authorized keys file. So for each machine (including the Pi) public SSH keys will need to be added. Most cloud providers facilitate this with <a href=https://cloud-init.io/>cloud-init</a> where any SSH public keys and other first time setup is configured after provision, so machines can be wired up to automation like Ansible without any manual intervention. Later in this guide, cloud-init will be used upon VM creation. But for the current baremetal hosts, a one time manual SSH and pull will suffice:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>apt install import-ssh-id
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@r720$ </span>ssh-import-id-gh robherley</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@nuc$ </span>apt install import-ssh-id
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>root@nuc$ </span>ssh-import-id-gh robherley</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>pi@piprimary$ </span>sudo apt install import-ssh-id
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>pi@piprimary$ </span>ssh-import-id-gh robherley</span></span></code></pre></div><p>Tedious right? Luckily that&rsquo;s the last time each host will need to be manually accessed.</p><h2 id=ansible-directory-configuration-and-inventory><a href=#ansible-directory-configuration-and-inventory>#</a>
Ansible directory, configuration and inventory</h2><p>Ansible loves being <a href=https://docs.ansible.com/ansible/2.3/playbooks_best_practices.html#content-organization>organized</a>, but some of the recommendations are overkill for my size of a homelab. This homelab will be condensed to mostly just playbooks, avoiding roles altogether. This directory is hosted on GitHub at <a href=https://github.com/robherley/homelab/tree/main/ansible>robherley/homelab</a>.</p><p>Within an <code>ansible</code> directory, start by making an extremely basic <code>ansible.cfg</code>. This&rsquo;ll set some defaults for any of the Ansible commands:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ca9ee6>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#8caaee>inventory</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>inventory ; the inventory directory</span>
</span></span><span style=display:flex><span><span style=color:#8caaee>vault_password_file</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>.vault_password ; password used for encrypting private values</span>
</span></span><span style=display:flex><span><span style=color:#8caaee>private_key_file</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>~/.ssh/id_ed25519_gmail ; path to SSH private key</span>
</span></span></code></pre></div><p>Then, make a <code>.vault_password</code> file. This is the password that&rsquo;ll be used to encrypt secrets with <a href=https://docs.ansible.com/ansible/latest/user_guide/vault.html>Ansible Vault</a>. That way, configuration can be commited to git without worrying about sensitive data (like passwords) being exposed. But it&rsquo;s also important to <strong><em>not commit</em></strong> this file to git with the rest of the configuration. This&rsquo;ll just be a plaintext file that contains a password, ie:</p><pre tabindex=0><code>correct-horse-battery-staple
</code></pre><p>Next is the <code>inventory</code> directory, with a <code>hosts</code> file inside of it. An <a href=https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html>inventory</a> is a very important construct in Ansible, it&rsquo;s a grouped list of the managed machines and some metadata on how to access them. The r720 and the NUC will be in a <code>proxmox</code> group, and the Raspberry Pi in a group of it&rsquo;s own called <code>pi</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ca9ee6>[proxmox]</span>
</span></span><span style=display:flex><span><span style=color:#8caaee>r720 ansible_host</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>192.168.1.100 ansible_user=root</span>
</span></span><span style=display:flex><span><span style=color:#8caaee>nuc ansible_host</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>192.168.1.200 ansible_user=root</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ca9ee6>[pi]</span>
</span></span><span style=display:flex><span><span style=color:#8caaee>piprimary ansible_host</span><span style=color:#99d1db;font-weight:700>=</span><span style=color:#a6d189>192.168.1.254 ansible_user=pi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#737994;font-style:italic>; note: all hosts are implicitly in the &#34;all&#34; group as well!</span>
</span></span></code></pre></div><p>Notice how the different Ansible users need to be specified, and some are even using the root user. It&rsquo;s better practice to have users that can escalate their priviledges when necessary (instead of <code>root</code> directly), so that&rsquo;ll change that in a bit.</p><p>To test that all the configuration is working, the Ansible group <code>all</code> can be pinged:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible all -m ping
</span></span><span style=display:flex><span>nuc | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>r720 | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python3&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span>
</span></span><span style=display:flex><span>piprimary | <span style=color:#f2d5cf>SUCCESS</span> <span style=color:#99d1db;font-weight:700>=</span>&gt; <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ansible_facts&#34;</span>: <span style=color:#99d1db;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a6d189>&#34;discovered_interpreter_python&#34;</span>: <span style=color:#a6d189>&#34;/usr/bin/python&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#99d1db;font-weight:700>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;changed&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#a6d189>&#34;ping&#34;</span>: <span style=color:#a6d189>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#99d1db;font-weight:700>}</span></span></span></code></pre></div><p>Great! All of the hosts are reachable. Time to start writing some playbooks.</p><h2 id=playbooks><a href=#playbooks>#</a>
Playbooks</h2><p>Playbooks are simply a set of tasks that need to run on hosts. The following playbooks will handle repeated tasks across the machines.</p><h3 id=fixing-proxmox-repositories><a href=#fixing-proxmox-repositories>#</a>
Fixing proxmox repositories</h3><p>By default, Proxmox attempts to use a paid <code>pve-enterprise</code> repository for its Debian packages. Luckily these can be switched out to the free <code>pve-no-subscription</code> packages. These are noted as &ldquo;less stable&rdquo; than the enterpise packages, but this is a homelab after all. You can read more about the Proxmox packages <a href=https://pve.proxmox.com/wiki/Package_Repositories>on their wiki</a>.</p><p>In <code>ansible/playbooks/patch-proxmox.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#ca9ee6>name</span>: patch-proxmox
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>become</span>: <span style=color:#ef9f76>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>hosts</span>:
</span></span><span style=display:flex><span>    - proxmox
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: add pve-no-subscription repository
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>apt_repository</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>repo</span>: deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: present
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>update_cache</span>: <span style=color:#ef9f76>no</span>
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: remove pve-enterprise repository
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>apt_repository</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>repo</span>: deb https://enterprise.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-enterprise
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: absent
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>update_cache</span>: <span style=color:#ef9f76>no</span>
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: update pkg cache and dist-upgrade
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>apt</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>update_cache</span>: <span style=color:#ef9f76>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>upgrade</span>: <span style=color:#a6d189>&#39;dist&#39;</span>
</span></span></code></pre></div><p>For the playbook <code>patch-proxmox.yml</code> above, it&rsquo;ll run three tasks on the <code>proxmox</code> group of hosts (the <code>r720</code> and <code>nuc</code>):</p><ol><li>Add the Proxmox <code>pve-no-subscription</code> debian repo based on the host&rsquo;s distribution release.</li><li>Remove the Proxmox <code>pve-enterprise</code> debian repo.</li><li>Run <code>apt update && apt dist-upgrade</code>.</li></ol><p>To run the playbook:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible-playbook ./playbooks/patch-proxmox.yml</span></span></code></pre></div><p>üí° Ansible has some great documentations on the <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html>builtin modules</a> such as the <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html#ansible-collections-ansible-builtin-apt-module><code>apt</code></a> and <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_repository_module.html#ansible-collections-ansible-builtin-apt-repository-module><code>apt_repository</code></a> modules used in the tasks above.</p><h3 id=add-a-sudoer><a href=#add-a-sudoer>#</a>
Add a sudoer</h3><p>As mentioned before, the <code>root</code> user is being used on the Proxmox hosts and <code>pi</code> user on the Raspberry Pi. It would be better to have a common known user as an entrypoint for automation, which is what the following playbook will do.</p><p>In <code>ansible/playbooks/setup-sudoers.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#ca9ee6>name</span>: add sudoers with ssh keys
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>hosts</span>:
</span></span><span style=display:flex><span>    - proxmox
</span></span><span style=display:flex><span>    - pi
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>become</span>: <span style=color:#ef9f76>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>gather_facts</span>: <span style=color:#ef9f76>no</span>
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#ca9ee6>users</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ca9ee6>name</span>: rob
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>github</span>: robherley
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>password</span>: $6$himalayan$E.K7G4g7NoIW69HLpmK1QDU1JMN4aaSYPOOGX1SwoSl.uqr64JruCEeDH0nLi9CxJR1/2HGTnTDVKfCC2ubub1
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: add sudo
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>apt</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>name</span>: sudo
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: present
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: add user
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>user</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>name</span>: <span style=color:#a6d189>&#34;{{ item.name }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>password</span>: <span style=color:#a6d189>&#34;{{ item.password }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>shell</span>: /bin/bash
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>with_items</span>: <span style=color:#a6d189>&#34;{{ users }}&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: enable passwordless sudo
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>lineinfile</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>dest</span>: /etc/sudoers.d/99-ansible-users
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: present
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>mode</span>: <span style=color:#ef9f76>0440</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>create</span>: <span style=color:#ef9f76>yes</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>regexp</span>: <span style=color:#a6d189>&#39;^{{ item.name }}&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>line</span>: <span style=color:#a6d189>&#39;{{ item.name }} ALL=(ALL) NOPASSWD: ALL&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>validate</span>: <span style=color:#a6d189>&#39;visudo -cf %s&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>with_items</span>: <span style=color:#a6d189>&#34;{{ users }}&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: add keys from github
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>authorized_key</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>key</span>: <span style=color:#a6d189>&#34;https://github.com/{{ item.github }}.keys&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>user</span>: <span style=color:#a6d189>&#34;{{ item.name }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>with_items</span>: <span style=color:#a6d189>&#34;{{ users }}&#34;</span>
</span></span></code></pre></div><p>For both the <code>pi</code> and <code>proxmox</code> host groups, it&rsquo;ll do the following:</p><ol><li>Make sure <code>sudo</code> is present on the machines.</li><li>Enable passwordless sudo for any user in the <code>sudo</code> group. The <code>lineinfile</code> also has a handy validation function which will validate the changes on a temporary file before overwriting. This way the sudoers file doesn&rsquo;t accidentally get borked.</li><li>For every <code>item</code> in the <code>users</code> var, create a user with <code>item.name</code>. The contents for <code>item.password</code> end up <em>exact</em> in <code>/etc/shadow</code>, so it must be hashed and salted beforehand. To do this, it can be generated with <code>openssl passwd -6 -salt &lt;salt> &lt;password></code>.</li><li>For every <code>item</code> in the <code>users</code> var, add authorized keys from GitHub based on the <code>item.github</code> key. This is similar to previous steps with <code>ssh-import-id</code>, but this is adding the public keys for the newly created user.</li></ol><p>And then run the playbook:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible-playbook ./playbooks/setup-sudoers.yml</span></span></code></pre></div><p>Now, all the machines should be accessible at <code>rob@&lt;host></code>, without using a password and with the ability to escalate to root.</p><p>The <code>ansible_user</code> attributes can now be removed from the <code>inventory</code> file:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>[proxmox]
</span></span><span style=display:flex><span><span style=color:#e78284;background-color:#414559>- r720 ansible_host=192.168.1.100 ansible_user=root
</span></span></span><span style=display:flex><span><span style=color:#e78284;background-color:#414559></span><span style=color:#a6d189;background-color:#414559>+ r720 ansible_host=192.168.1.100
</span></span></span><span style=display:flex><span><span style=color:#a6d189;background-color:#414559></span><span style=color:#e78284;background-color:#414559>- nuc ansible_host=192.168.1.200 ansible_user=root
</span></span></span><span style=display:flex><span><span style=color:#e78284;background-color:#414559></span><span style=color:#a6d189;background-color:#414559>+ nuc ansible_host=192.168.1.200
</span></span></span><span style=display:flex><span><span style=color:#a6d189;background-color:#414559></span>
</span></span><span style=display:flex><span>[pi]
</span></span><span style=display:flex><span><span style=color:#e78284;background-color:#414559>- piprimary ansible_host=192.168.1.254 ansible_user=pi
</span></span></span><span style=display:flex><span><span style=color:#e78284;background-color:#414559></span><span style=color:#a6d189;background-color:#414559>+ piprimary ansible_host=192.168.1.254
</span></span></span></code></pre></div><p>And set the default remote user in <code>ansible.cfg</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>[defaults]
</span></span><span style=display:flex><span>inventory=inventory
</span></span><span style=display:flex><span>vault_password_file=.vault_password
</span></span><span style=display:flex><span>private_key_file=~/.ssh/id_ed25519_gmailkey
</span></span><span style=display:flex><span><span style=color:#a6d189;background-color:#414559>+ remote_user=rob
</span></span></span></code></pre></div><p>Then verify that the remotes are still reachable with <code>ansible all -m ping</code>. If this command fails, the configuration is incorrect.</p><h3 id=harden-ssh><a href=#harden-ssh>#</a>
Harden SSH</h3><p>Now that there&rsquo;s a separate user as an entrypoint (with SSH keys), <code>root</code> access can be disabled* as well as password access for SSH:</p><p>In <code>ansible/playbooks/harden-ssh.yml</code>:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#ca9ee6>name</span>: harden ssh connection
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>become</span>: <span style=color:#ef9f76>yes</span>
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>hosts</span>:
</span></span><span style=display:flex><span>    - proxmox
</span></span><span style=display:flex><span>    - pi
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: assert non-root user
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>assert</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>that</span>:
</span></span><span style=display:flex><span>          - ansible_user != &#34;root&#34;
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>fail_msg</span>: <span style=color:#a6d189>&#34;must run this playbook as non-root to ensure SSH works&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>success_msg</span>: <span style=color:#a6d189>&#34;successfully connected as non-root!&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: disable password login
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>lineinfile</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>dest</span>: /etc/ssh/sshd_config
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: present
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>regexp</span>: <span style=color:#a6d189>&#39;^PasswordAuthentication&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>line</span>: <span style=color:#a6d189>&#39;PasswordAuthentication no&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>validate</span>: <span style=color:#a6d189>&#39;sshd -t -f %s&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>notify</span>:
</span></span><span style=display:flex><span>        - restart-sshd
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: disable root login
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>when</span>: <span style=color:#a6d189>&#34;&#39;proxmox&#39; not in group_names&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>lineinfile</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>dest</span>: /etc/ssh/sshd_config
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: present
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>regexp</span>: <span style=color:#a6d189>&#39;^PermitRootLogin&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>line</span>: <span style=color:#a6d189>&#39;PermitRootLogin no&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>validate</span>: <span style=color:#a6d189>&#39;sshd -t -f %s&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>notify</span>:
</span></span><span style=display:flex><span>        - restart-sshd
</span></span><span style=display:flex><span>  <span style=color:#ca9ee6>handlers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ca9ee6>name</span>: restart-sshd
</span></span><span style=display:flex><span>      <span style=color:#ca9ee6>service</span>:
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>name</span>: sshd
</span></span><span style=display:flex><span>        <span style=color:#ca9ee6>state</span>: restarted
</span></span></code></pre></div><p>For both the <code>pi</code> and <code>proxmox</code> host groups, it&rsquo;ll do the following:</p><ol><li>A basic assert on the current <code>ansible_user</code> to make sure it isn&rsquo;t using root to connect.</li><li>Disabling password login for ssh, and validating with <code>sshd -t</code>.</li><li>Disabling root login for ssh, and validating with <code>sshd -t</code>. Note there&rsquo;s a special <code>when</code> statement checking if the current host is in the <code>proxmox</code> group. *We want to leave root login enabled for these, since Proxmox requires root SSH for the web console shell access and for live migration.</li></ol><p>üí° These tasks also use a <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_handlers.html><code>handler</code></a> to execute an additional action only after the task has <em>changed</em>. In the case above, anytime we the sshd configuration changes, the service is restarted.</p><p>And to run the playbook:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ansible-playbook ./playbooks/harden-ssh.yml</span></span></code></pre></div><p>Now, SSH access via <code>root</code> is locked for non-Proxmox hosts:</p><div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ssh root@192.168.1.254
</span></span><span style=display:flex><span>root@192.168.1.254: Permission denied <span style=color:#99d1db;font-weight:700>(</span>publickey<span style=color:#99d1db;font-weight:700>)</span>.</span></span></code></pre></div><p>But it is accessible via the new user and can escalate when necessary:<div class=highlight><pre tabindex=0 style=color:#c6d0f5;background-color:#303446;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@macbook$ </span>ssh rob@192.168.1.254
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@piprimary$ </span>id
</span></span><span style=display:flex><span><span style=color:#f2d5cf>uid</span><span style=color:#99d1db;font-weight:700>=</span>1000<span style=color:#99d1db;font-weight:700>(</span>rob<span style=color:#99d1db;font-weight:700>)</span> <span style=color:#f2d5cf>gid</span><span style=color:#99d1db;font-weight:700>=</span>1001<span style=color:#99d1db;font-weight:700>(</span>rob<span style=color:#99d1db;font-weight:700>)</span> <span style=color:#f2d5cf>groups</span><span style=color:#99d1db;font-weight:700>=</span>1001<span style=color:#99d1db;font-weight:700>(</span>rob<span style=color:#99d1db;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#81c8be;user-select:none>rob@piprimary$ </span>sudo su - <span style=color:#737994;font-style:italic># escalate with no password required!</span>
</span></span><span style=display:flex><span>root@piprimary$</span></span></code></pre></div></p><h2 id=next><a href=#next>#</a>
Next</h2><p>All of the groundwork for homelab automation is now in place, and easily extendable. In the next part, I&rsquo;ll dive deeper into automated Proxmox management and container templating.</p></div></article><div class=prev-next><div><a href=https://blog.reb.gg/posts/02-homelab-pt2/>&#8592; Prev</a>
<span>üè° Homelab II: Proxmox cluster, ZFS and ‚Ä¶</span></div><div><a style=align-self:flex-end href=https://blog.reb.gg/posts/04-homelab-pt4/>Next &#8594;</a>
<span>üè° Homelab IV: Proxmox Dynamic Inventory ‚Ä¶</span></div></div></main><footer><div class=stripes></div><div class=footer-meta><div><div>2024 Rob Herley</div><div>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> &
      <a href=https://github.com/robherley/rebugo target=_blank rel="noopener noreferrer">robherley/rebugo</a></div></div><div class=socials><a href=https://github.com/robherley rel=author title=github><i class="si si-github"></i></a><a href=https://x.com/robherley rel=author title=x><i class="si si-x"></i></a><a href=https://instagram.com/robherley rel=author title=instagram><i class="si si-instagram"></i></a><a href=https://www.linkedin.com/in/robherley/ rel=author title=linkedin><i class="si si-linkedin"></i></a></div></div></footer></body></html>