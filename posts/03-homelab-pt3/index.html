<!doctype html><html lang=en>
<head>
<title>
Homelab Part III: Automation with Ansible and Hardening Access ::
rob's blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I&amp;rsquo;ll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This&amp;rsquo;ll all be through an automatic, idempotent configuration process.
What is Ansible? Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it&amp;rsquo;s an extremely popular tool making it a great learning exercise for the homelab.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=http://blog.reb.gg/posts/03-homelab-pt3/>
<link rel=stylesheet href=http://blog.reb.gg/assets/style.css>
<link rel=stylesheet href=http://blog.reb.gg/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=http://blog.reb.gg/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=http://blog.reb.gg/img/favicon.png>
<link href=http://blog.reb.gg/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=http://blog.reb.gg/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=http://blog.reb.gg/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=http://blog.reb.gg/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=http://blog.reb.gg/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=http://blog.reb.gg/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Homelab Part III: Automation with Ansible and Hardening Access">
<meta name=twitter:description content="In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I&rsquo;ll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This&rsquo;ll all be through an automatic, idempotent configuration process.
What is Ansible? Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it&rsquo;s an extremely popular tool making it a great learning exercise for the homelab.">
<meta property="og:title" content="Homelab Part III: Automation with Ansible and Hardening Access">
<meta property="og:description" content="In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I&rsquo;ll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This&rsquo;ll all be through an automatic, idempotent configuration process.
What is Ansible? Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it&rsquo;s an extremely popular tool making it a great learning exercise for the homelab.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://blog.reb.gg/posts/03-homelab-pt3/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-09T03:00:00-05:00">
<meta property="article:modified_time" content="2022-01-09T03:00:00-05:00"><meta property="og:site_name" content="rob's blog">
</head>
<body class=dark-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>rob's blog</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>Homelab Part III: Automation with Ansible and Hardening Access</h1>
<div class=post-meta>
<span class=post-date>
2022-01-09
</span>
<span class=post-read-time>— 8 min read</span>
</div>
<div class=post-content>
<p>In the previous part of this series, I created a two-node Proxmox cluster along with redundant (ZFS) and shared (NFS) storage. In this part, I&rsquo;ll go over how to connect to the host machines with Ansible, harden access, and setup some minor user management. This&rsquo;ll all be through an automatic, idempotent configuration process.</p>
<h2 id=what-is-ansible>What is Ansible?</h2>
<p>Ansible is a great automation platform from Red Hat (they bought AnsibleWorks), and it&rsquo;s an extremely popular tool making it a great learning exercise for the homelab. It has an agentless architecture, so it&rsquo;s super simple to setup only requiring an SSH connection. I&rsquo;ll use my laptop to manage Ansible to the controlled machines. In a &ldquo;real world&rdquo; environment, this would typically be done on a <a href=https://en.wikipedia.org/wiki/Bastion_host>bastion</a>.</p>
<h2 id=installing-ansible-locally>Installing Ansible locally</h2>
<p>Ansible can most likely be found on <a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-on-specific-operating-systems>your favorite package manager</a>, but it can also be installed via <a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-and-upgrading-ansible-with-pip><code>pip</code></a>. We&rsquo;ll be making <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html>playbooks</a> to handle some of the automation of our homelab.</p>
<h2 id=adding-ssh-keys-for-controlled-access>Adding SSH keys for controlled access</h2>
<p>Since Ansible is agentless and uses SSH, each machine will need minor config changes for the initial access. Using password authentication for SSH generally isn&rsquo;t a good idea, so SSH key verification will be used. The <a href=http://manpages.ubuntu.com/manpages/focal/man1/ssh-import-id.1.html><code>ssh-import-id</code></a> utility is great for this, it can pull public keys from sources like <a href=https://github.com/>GitHub</a> or <a href=https://launchpad.net/>Canonical Launchpad</a> and add them to an authorized keys file. So for each machine (including the Pi) public SSH keys will need to be added. Most cloud providers facilitate this with <a href=https://cloud-init.io/>cloud-init</a> where any SSH public keys and other first time setup is configured after provision, so machines can be wired up to automation like Ansible without any manual intervention. Later in this guide, cloud-init will be used upon VM creation. But for the current baremetal hosts, a one time manual SSH and pull will suffice:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>root@r720$ apt install import-ssh-id
root@r720$ ssh-import-id-gh robherley
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>root@nuc$ apt install import-ssh-id
root@nuc$ ssh-import-id-gh robherley
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>pi@piprimary$ sudo apt install import-ssh-id
pi@piprimary$ ssh-import-id-gh robherley
</code></pre></div><p>Tedious right? Luckily that&rsquo;s the last time each host will need to be manually accessed.</p>
<h2 id=ansible-directory-configuration-and-inventory>Ansible directory, configuration and inventory</h2>
<p>Ansible loves being <a href=https://docs.ansible.com/ansible/2.3/playbooks_best_practices.html#content-organization>organized</a>, but some of the recommendations are overkill for my size of a homelab. This homelab will be condensed to mostly just playbooks, avoiding roles altogether. This directory is hosted on GitHub at <a href=https://github.com/robherley/homelab/tree/main/ansible>robherley/homelab</a>.</p>
<p>Within an <code>ansible</code> directory, start by making an extremely basic <code>ansible.cfg</code>. This&rsquo;ll set some defaults for any of the Ansible commands:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[defaults]</span>
<span style=color:#a6e22e>inventory</span><span style=color:#f92672>=</span><span style=color:#e6db74>inventory ; the inventory directory</span>
<span style=color:#a6e22e>vault_password_file</span><span style=color:#f92672>=</span><span style=color:#e6db74>.vault_password ; password used for encrypting private values</span>
<span style=color:#a6e22e>private_key_file</span><span style=color:#f92672>=</span><span style=color:#e6db74>~/.ssh/id_ed25519_gmail ; path to SSH private key</span>
</code></pre></div><p>Then, make a <code>.vault_password</code> file. This is the password that&rsquo;ll be used to encrypt secrets with <a href=https://docs.ansible.com/ansible/latest/user_guide/vault.html>Ansible Vault</a>. That way, configuration can be commited to git without worrying about sensitive data (like passwords) being exposed. But it&rsquo;s also important to <strong><em>not commit</em></strong> this file to git with the rest of the configuration. This&rsquo;ll just be a plaintext file that contains a password, ie:</p>
<pre tabindex=0><code>correct-horse-battery-staple
</code></pre><p>Next is the <code>inventory</code> directory, with a <code>hosts</code> file inside of it. An <a href=https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html>inventory</a> is a very important construct in Ansible, it&rsquo;s a grouped list of the managed machines and some metadata on how to access them. The r720 and the NUC will be in a <code>proxmox</code> group, and the Raspberry Pi in a group of it&rsquo;s own called <code>pi</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[proxmox]</span>
<span style=color:#a6e22e>r720 ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.100 ansible_user=root</span>
<span style=color:#a6e22e>nuc ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.200 ansible_user=root</span>

<span style=color:#66d9ef>[pi]</span>
<span style=color:#a6e22e>piprimary ansible_host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.1.254 ansible_user=pi</span>

<span style=color:#75715e>; note: all hosts are implicitly in the &#34;all&#34; group as well!</span>
</code></pre></div><p>Notice how the different Ansible users need to be specified, and some are even using the root user. It&rsquo;s better practice to have users that can escalate their priviledges when necessary (instead of <code>root</code> directly), so that&rsquo;ll change that in a bit.</p>
<p>To test that all the configuration is working, the Ansible group <code>all</code> can be pinged:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>rob@macbook$ ansible all -m ping
nuc | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python3&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
r720 | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python3&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
piprimary | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
</code></pre></div><p>Great! All of the hosts are reachable. Time to start writing some playbooks.</p>
<h2 id=playbooks>Playbooks</h2>
<p>Playbooks are simply a set of tasks that need to run on hosts. The following playbooks will handle repeated tasks across the machines.</p>
<h3 id=fixing-proxmox-repositories>Fixing proxmox repositories</h3>
<p>By default, Proxmox attempts to use a paid <code>pve-enterprise</code> repository for its Debian packages. Luckily these can be switched out to the free <code>pve-no-subscription</code> packages. These are noted as &ldquo;less stable&rdquo; than the enterpise packages, but this is a homelab after all. You can read more about the Proxmox packages <a href=https://pve.proxmox.com/wiki/Package_Repositories>on their wiki</a>.</p>
<p>In <code>ansible/playbooks/patch-proxmox.yml</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>patch-proxmox</span>
  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
  <span style=color:#f92672>hosts</span>:
    - <span style=color:#ae81ff>proxmox</span>
  <span style=color:#f92672>tasks</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>add pve-no-subscription repository</span>
      <span style=color:#f92672>apt_repository</span>:
        <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
        <span style=color:#f92672>update_cache</span>: <span style=color:#66d9ef>no</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>remove pve-enterprise repository</span>
      <span style=color:#f92672>apt_repository</span>:
        <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>deb https://enterprise.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-enterprise</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>absent</span>
        <span style=color:#f92672>update_cache</span>: <span style=color:#66d9ef>no</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>update pkg cache and dist-upgrade</span>
      <span style=color:#f92672>apt</span>:
        <span style=color:#f92672>update_cache</span>: <span style=color:#66d9ef>yes</span>
        <span style=color:#f92672>upgrade</span>: <span style=color:#e6db74>&#39;dist&#39;</span>
</code></pre></div><p>For the playbook <code>patch-proxmox.yml</code> above, it&rsquo;ll run three tasks on the <code>proxmox</code> group of hosts (the <code>r720</code> and <code>nuc</code>):</p>
<ol>
<li>Add the Proxmox <code>pve-no-subscription</code> debian repo based on the host&rsquo;s distribution release.</li>
<li>Remove the Proxmox <code>pve-enterprise</code> debian repo.</li>
<li>Run <code>apt update && apt dist-upgrade</code>.</li>
</ol>
<p>To run the playbook:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>rob@macbook$ ansible-playbook ./playbooks/patch-proxmox.yml
</code></pre></div><p>💡 Ansible has some great documentations on the <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html>builtin modules</a> such as the <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html#ansible-collections-ansible-builtin-apt-module><code>apt</code></a> and <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_repository_module.html#ansible-collections-ansible-builtin-apt-repository-module><code>apt_repository</code></a> modules used in the tasks above.</p>
<h3 id=add-a-sudoer>Add a sudoer</h3>
<p>As mentioned before, the <code>root</code> user is being used on the Proxmox hosts and <code>pi</code> user on the Raspberry Pi. It would be better to have a common known user as an entrypoint for automation, which is what the following playbook will do.</p>
<p>In <code>ansible/playbooks/setup-sudoers.yml</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>add sudoers with ssh keys</span>
  <span style=color:#f92672>hosts</span>:
    - <span style=color:#ae81ff>proxmox</span>
    - <span style=color:#ae81ff>pi</span>
  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
  <span style=color:#f92672>gather_facts</span>: <span style=color:#66d9ef>no</span>
  <span style=color:#f92672>vars</span>:
    <span style=color:#f92672>users</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>rob</span>
        <span style=color:#f92672>github</span>: <span style=color:#ae81ff>robherley</span>
        <span style=color:#f92672>password</span>: <span style=color:#ae81ff>$6$himalayan$E.K7G4g7NoIW69HLpmK1QDU1JMN4aaSYPOOGX1SwoSl.uqr64JruCEeDH0nLi9CxJR1/2HGTnTDVKfCC2ubub1</span>
  <span style=color:#f92672>tasks</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>add sudo</span>
      <span style=color:#f92672>apt</span>:
        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sudo</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>add user</span>
      <span style=color:#f92672>user</span>:
        <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;{{ item.name }}&#34;</span>
        <span style=color:#f92672>password</span>: <span style=color:#e6db74>&#34;{{ item.password }}&#34;</span>
        <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>/bin/bash</span>
      <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ users }}&#34;</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>enable passwordless sudo</span>
      <span style=color:#f92672>lineinfile</span>:
        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/sudoers.d/99-ansible-users</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
        <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>0440</span>
        <span style=color:#f92672>create</span>: <span style=color:#66d9ef>yes</span>
        <span style=color:#f92672>regexp</span>: <span style=color:#e6db74>&#39;^{{ item.name }}&#39;</span>
        <span style=color:#f92672>line</span>: <span style=color:#e6db74>&#39;{{ item.name }} ALL=(ALL) NOPASSWD: ALL&#39;</span>
        <span style=color:#f92672>validate</span>: <span style=color:#e6db74>&#39;visudo -cf %s&#39;</span>
      <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ users }}&#34;</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>add keys from github</span>
      <span style=color:#f92672>authorized_key</span>:
        <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;https://github.com/{{ item.github }}.keys&#34;</span>
        <span style=color:#f92672>user</span>: <span style=color:#e6db74>&#34;{{ item.name }}&#34;</span>
      <span style=color:#f92672>with_items</span>: <span style=color:#e6db74>&#34;{{ users }}&#34;</span>
</code></pre></div><p>For both the <code>pi</code> and <code>proxmox</code> host groups, it&rsquo;ll do the following:</p>
<ol>
<li>Make sure <code>sudo</code> is present on the machines.</li>
<li>Enable passwordless sudo for any user in the <code>sudo</code> group. The <code>lineinfile</code> also has a handy validation function which will validate the changes on a temporary file before overwriting. This way the sudoers file doesn&rsquo;t accidentally get borked.</li>
<li>For every <code>item</code> in the <code>users</code> var, create a user with <code>item.name</code>. The contents for <code>item.password</code> end up <em>exact</em> in <code>/etc/shadow</code>, so it must be hashed and salted beforehand. To do this, it can be generated with <code>openssl passwd -6 -salt &lt;salt> &lt;password></code>.</li>
<li>For every <code>item</code> in the <code>users</code> var, add authorized keys from GitHub based on the <code>item.github</code> key. This is similar to previous steps with <code>ssh-import-id</code>, but this is adding the public keys for the newly created user.</li>
</ol>
<p>And then run the playbook:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>rob@macbook$ ansible-playbook ./playbooks/setup-sudoers.yml
</code></pre></div><p>Now, all the machines should be accessible at <code>rob@&lt;host></code>, without using a password and with the ability to escalate to root.</p>
<p>The <code>ansible_user</code> attributes can now be removed from the <code>inventory</code> file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>[proxmox]
<span style=color:#f92672>- r720 ansible_host=192.168.1.100 ansible_user=root
</span><span style=color:#f92672></span><span style=color:#a6e22e>+ r720 ansible_host=192.168.1.100
</span><span style=color:#a6e22e></span><span style=color:#f92672>- nuc ansible_host=192.168.1.200 ansible_user=root
</span><span style=color:#f92672></span><span style=color:#a6e22e>+ nuc ansible_host=192.168.1.200
</span><span style=color:#a6e22e></span>
[pi]
<span style=color:#f92672>- piprimary ansible_host=192.168.1.254 ansible_user=pi
</span><span style=color:#f92672></span><span style=color:#a6e22e>+ piprimary ansible_host=192.168.1.254
</span></code></pre></div><p>And set the default remote user in <code>ansible.cfg</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>[defaults]
inventory=inventory
vault_password_file=.vault_password
private_key_file=~/.ssh/id_ed25519_gmailkey
<span style=color:#a6e22e>+ remote_user=rob
</span></code></pre></div><p>Then verify that the remotes are still reachable with <code>ansible all -m ping</code>. If this command fails, the configuration is incorrect.</p>
<h3 id=harden-ssh>Harden SSH</h3>
<p>Now that there&rsquo;s a separate user as an entrypoint (with SSH keys), <code>root</code> access can be disabled* as well as password access for SSH:</p>
<p>In <code>ansible/playbooks/harden-ssh.yml</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>harden ssh connection</span>
  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
  <span style=color:#f92672>hosts</span>:
    - <span style=color:#ae81ff>proxmox</span>
    - <span style=color:#ae81ff>pi</span>
  <span style=color:#f92672>tasks</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>assert non-root user</span>
      <span style=color:#f92672>assert</span>:
        <span style=color:#f92672>that</span>:
          - <span style=color:#ae81ff>ansible_user != &#34;root&#34;</span>
        <span style=color:#f92672>fail_msg</span>: <span style=color:#e6db74>&#34;must run this playbook as non-root to ensure SSH works&#34;</span>
        <span style=color:#f92672>success_msg</span>: <span style=color:#e6db74>&#34;successfully connected as non-root!&#34;</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disable password login</span>
      <span style=color:#f92672>lineinfile</span>:
        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/ssh/sshd_config</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
        <span style=color:#f92672>regexp</span>: <span style=color:#e6db74>&#39;^PasswordAuthentication&#39;</span>
        <span style=color:#f92672>line</span>: <span style=color:#e6db74>&#39;PasswordAuthentication no&#39;</span>
        <span style=color:#f92672>validate</span>: <span style=color:#e6db74>&#39;sshd -t -f %s&#39;</span>
      <span style=color:#f92672>notify</span>:
        - <span style=color:#ae81ff>restart-sshd</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disable root login</span>
      <span style=color:#f92672>when</span>: <span style=color:#e6db74>&#34;&#39;proxmox&#39; not in group_names&#34;</span>
      <span style=color:#f92672>lineinfile</span>:
        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/ssh/sshd_config</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
        <span style=color:#f92672>regexp</span>: <span style=color:#e6db74>&#39;^PermitRootLogin&#39;</span>
        <span style=color:#f92672>line</span>: <span style=color:#e6db74>&#39;PermitRootLogin no&#39;</span>
        <span style=color:#f92672>validate</span>: <span style=color:#e6db74>&#39;sshd -t -f %s&#39;</span>
      <span style=color:#f92672>notify</span>:
        - <span style=color:#ae81ff>restart-sshd</span>
  <span style=color:#f92672>handlers</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>restart-sshd</span>
      <span style=color:#f92672>service</span>:
        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sshd</span>
        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>restarted</span>
</code></pre></div><p>For both the <code>pi</code> and <code>proxmox</code> host groups, it&rsquo;ll do the following:</p>
<ol>
<li>A basic assert on the current <code>ansible_user</code> to make sure it isn&rsquo;t using root to connect.</li>
<li>Disabling password login for ssh, and validating with <code>sshd -t</code>.</li>
<li>Disabling root login for ssh, and validating with <code>sshd -t</code>. Note there&rsquo;s a special <code>when</code> statement checking if the current host is in the <code>proxmox</code> group. *We want to leave root login enabled for these, since Proxmox requires root SSH for the web console shell access and for live migration.</li>
</ol>
<p>💡 These tasks also use a <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_handlers.html><code>handler</code></a> to execute an additional action only after the task has <em>changed</em>. In the case above, anytime we the sshd configuration changes, the service is restarted.</p>
<p>And to run the playbook:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>rob@macbook$ ansible-playbook ./playbooks/harden-ssh.yml
</code></pre></div><p>Now, SSH access via <code>root</code> is locked for non-Proxmox hosts:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>rob@macbook$ ssh root@192.168.1.254
root@192.168.1.254: Permission denied (publickey).
</code></pre></div><p>But it is accessible via the new user and can escalate when necessary:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console>rob@macbook$ ssh rob@192.168.1.254
rob@piprimary$ id
uid=1000(rob) gid=1001(rob) groups=1001(rob)
rob@piprimary$ sudo su - # escalate with no password required!
root@piprimary$
</code></pre></div><h2 id=next>Next</h2>
<p>All of the groundwork for homelab automation is now in place, and easily extendable. In the next part, I&rsquo;ll dive deeper into automated Proxmox management and container templating.</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=http://blog.reb.gg/posts/04-homelab-pt4/>
<span class=button__icon>←</span>
<span class=button__text>Homelab Part IV: Proxmox Dynamic Inventory and LXC Templates</span>
</a>
</span>
<span class="button next">
<a href=http://blog.reb.gg/posts/02-homelab-pt2/>
<span class=button__text>Homelab Part II: Proxmox cluster, ZFS and NFS</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>rob's blog</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=http://blog.reb.gg/assets/main.js></script>
<script src=http://blog.reb.gg/assets/prism.js></script>
</div>
</body>
</html>